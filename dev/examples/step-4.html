

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Example 4: Solving the Navier-Stokes equations in parallel &mdash; ideal.II  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b20cc3f5" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/graphviz.css?v=4ae1632d" />
      <link rel="stylesheet" type="text/css" href="../_static/maths_admonition.css?v=597dd67d" />
      <link rel="stylesheet" type="text/css" href="../_static/dark_mode_css/general.css?v=c0a7eb24" />
      <link rel="stylesheet" type="text/css" href="../_static/dark_mode_css/dark.css?v=70edf1c7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      <script src="../_static/dark_mode_js/default_dark.js?v=fd565c74"></script>
      <script src="../_static/dark_mode_js/theme_switcher.js?v=358d3910"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Example 3: Solving the heat equation in parallel" href="step-3.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search"  style="background: #450d54" >

          
          
          <a href="../index.html">
            
              <img src="../_static/idealii_logo_text.png" class="logo" alt="Logo"/>
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Get ideal.II</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../installation.html">Installation</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Mathematical foundations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../maths/function_spaces.html">Space-time function spaces</a></li>
<li class="toctree-l1"><a class="reference internal" href="../maths/discretization.html">Finite element discretization</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Tutorial examples</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="overview.html">Example overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="step-1.html">Example 1: Solving the heat equation</a></li>
<li class="toctree-l1"><a class="reference internal" href="step-2.html">Example 2: Solving the linear Stokes equation</a></li>
<li class="toctree-l1"><a class="reference internal" href="step-3.html">Example 3: Solving the heat equation in parallel</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Example 4: Solving the Navier-Stokes equations in parallel</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#introduction">Introduction</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#weak-formulations-of-the-navier-stokes-equation">Weak formulations of the Navier-Stokes equation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#problem-statement">Problem statement</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#the-commented-program">The commented program</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#include-files">include files</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#ideal-ii-includes">ideal.II includes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#deal-ii-includes">deal.II includes</a></li>
<li class="toctree-l4"><a class="reference internal" href="#trilinos-and-c-includes">Trilinos and C++ includes</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#space-time-functions">Space-time functions</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-step4-class">The Step4 class</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#step4-step4">Step4::Step4</a></li>
<li class="toctree-l4"><a class="reference internal" href="#step4-run">Step4::run</a></li>
<li class="toctree-l4"><a class="reference internal" href="#step4-make-grid">Step4::make_grid</a></li>
<li class="toctree-l4"><a class="reference internal" href="#step4-time-marching">Step4::time_marching</a></li>
<li class="toctree-l4"><a class="reference internal" href="#step4-setup-system-on-slab">Step4::setup_system_on_slab</a></li>
<li class="toctree-l4"><a class="reference internal" href="#step4-assemble-system-on-slab">Step4::assemble_system_on_slab</a></li>
<li class="toctree-l4"><a class="reference internal" href="#step4-assemble-residual-on-slab">Step4::assemble_residual_on_slab</a></li>
<li class="toctree-l4"><a class="reference internal" href="#step4-solve-newton-problem-on-slab">Step4::solve_Newton_problem_on_slab</a></li>
<li class="toctree-l4"><a class="reference internal" href="#step4-calculate-functional-values-on-slab">Step4::calculate_functional_values_on_slab</a></li>
<li class="toctree-l4"><a class="reference internal" href="#step4-calculate-pressure-at-point">Step4::calculate_pressure_at_point</a></li>
<li class="toctree-l4"><a class="reference internal" href="#step4-calculate-drag-lift-tensor">Step4::calculate_drag_lift_tensor</a></li>
<li class="toctree-l4"><a class="reference internal" href="#step4-output-results-on-slab">Step4::output_results_on_slab</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#the-main-function">The main function</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#results">Results</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#comparison-to-benchmark-results">Comparison to benchmark results</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#the-plain-program">The plain program</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Doxygen API Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://instatdealii.github.io/idealii/dev/doxygen/index.html">Index</a></li>
<li class="toctree-l1"><a class="reference external" href="https://instatdealii.github.io/idealii/dev/doxygen/namespaces.html">Namespace List</a></li>
<li class="toctree-l1"><a class="reference external" href="https://instatdealii.github.io/idealii/dev/doxygen/classes.html">Class List</a></li>
<li class="toctree-l1"><a class="reference external" href="https://instatdealii.github.io/idealii/dev/doxygen/files.html">File List</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu"  style="background: #450d54" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">ideal.II</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Example 4: Solving the Navier-Stokes equations in parallel</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/examples/step-4.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="example-4-solving-the-navier-stokes-equations-in-parallel">
<span id="step-4"></span><h1>Example 4: Solving the Navier-Stokes equations in parallel<a class="headerlink" href="#example-4-solving-the-navier-stokes-equations-in-parallel" title="Link to this heading"></a></h1>
<nav class="contents local" id="contents">
<ul class="simple">
<li><p><a class="reference internal" href="#introduction" id="id2">Introduction</a></p>
<ul>
<li><p><a class="reference internal" href="#weak-formulations-of-the-navier-stokes-equation" id="id3">Weak formulations of the Navier-Stokes equation</a></p></li>
<li><p><a class="reference internal" href="#problem-statement" id="id4">Problem statement</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#the-commented-program" id="id5">The commented program</a></p>
<ul>
<li><p><a class="reference internal" href="#include-files" id="id6">include files</a></p>
<ul>
<li><p><a class="reference internal" href="#ideal-ii-includes" id="id7">ideal.II includes</a></p></li>
<li><p><a class="reference internal" href="#deal-ii-includes" id="id8">deal.II includes</a></p></li>
<li><p><a class="reference internal" href="#trilinos-and-c-includes" id="id9">Trilinos and C++ includes</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#space-time-functions" id="id10">Space-time functions</a></p></li>
<li><p><a class="reference internal" href="#the-step4-class" id="id11">The Step4 class</a></p>
<ul>
<li><p><a class="reference internal" href="#step4-step4" id="id12">Step4::Step4</a></p></li>
<li><p><a class="reference internal" href="#step4-run" id="id13">Step4::run</a></p></li>
<li><p><a class="reference internal" href="#step4-make-grid" id="id14">Step4::make_grid</a></p></li>
<li><p><a class="reference internal" href="#step4-time-marching" id="id15">Step4::time_marching</a></p></li>
<li><p><a class="reference internal" href="#step4-setup-system-on-slab" id="id16">Step4::setup_system_on_slab</a></p></li>
<li><p><a class="reference internal" href="#step4-assemble-system-on-slab" id="id17">Step4::assemble_system_on_slab</a></p></li>
<li><p><a class="reference internal" href="#step4-assemble-residual-on-slab" id="id18">Step4::assemble_residual_on_slab</a></p></li>
<li><p><a class="reference internal" href="#step4-solve-newton-problem-on-slab" id="id19">Step4::solve_Newton_problem_on_slab</a></p></li>
<li><p><a class="reference internal" href="#step4-calculate-functional-values-on-slab" id="id20">Step4::calculate_functional_values_on_slab</a></p></li>
<li><p><a class="reference internal" href="#step4-calculate-pressure-at-point" id="id21">Step4::calculate_pressure_at_point</a></p></li>
<li><p><a class="reference internal" href="#step4-calculate-drag-lift-tensor" id="id22">Step4::calculate_drag_lift_tensor</a></p></li>
<li><p><a class="reference internal" href="#step4-output-results-on-slab" id="id23">Step4::output_results_on_slab</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#the-main-function" id="id24">The main function</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#results" id="id25">Results</a></p>
<ul>
<li><p><a class="reference internal" href="#comparison-to-benchmark-results" id="id26">Comparison to benchmark results</a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#the-plain-program" id="id27">The plain program</a></p></li>
</ul>
</nav>
<section id="introduction">
<h2><a class="toc-backref" href="#id2" role="doc-backlink">Introduction</a><a class="headerlink" href="#introduction" title="Link to this heading"></a></h2>
<p>In this tutorial we will look at how to solve a nonliner problem in
<em>ideal.II</em>.</p>
<p>It extends the couples Stokes equation from <a class="reference internal" href="step-2.html#step-2"><span class="std std-ref">Example 2: Solving the linear Stokes equation</span></a>
and solves the nonlinear Navier-Stokes equation.
For the linear algebra it builds upon <a class="reference internal" href="step-3.html#step-3"><span class="std std-ref">Example 3: Solving the heat equation in parallel</span></a> and uses
the MPI parallel linear algebra provided through Trilinos as well.</p>
<p>The Navier-Stokes equation is again a coupled problem between a vector-valued velocity
<span class="math notranslate nohighlight">\(\bf u\in\mathbb{R}^d\)</span> and a scalar-valued pressure <span class="math notranslate nohighlight">\(p\in\mathbb{R}\)</span>.
Compared to the previous Stokes equation we now take into account
the effect of the fluid motion on the fluid itself through the
nonlinear convection term <span class="math notranslate nohighlight">\(\mathbf{u}\cdot\nabla\mathbf{u}\)</span>.</p>
<div class="admonition-navier-stokes-equation-in-strong-formulation maths-equation admonition" id="maths-equation-0">
<p class="admonition-title">Navier-Stokes equation in strong formulation</p>
<p>The strong formulation reads as follows:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\partial_t \mathbf{u} - \nu\Delta\mathbf{u}
+\mathbf{u}\cdot\nabla_x\mathbf{u}+\nabla_x p &amp;= 0\text{ in }Q \\
\nabla_x\cdot \mathbf{u} &amp;= 0 \\
\mathbf{u} &amp;= \mathbf{g}_D \text{ on }\Gamma_D\times I\\
\partial_n\mathbf{u} &amp;= 0\text{ on }\Gamma_N\times I\\
\mathbf{u} &amp;= \mathbf{u}^0 \text{ on }\Omega\times\{0\}\end{split}\]</div>
<p>with kinematic viscosity <span class="math notranslate nohighlight">\(\nu\in\mathbb{R}\)</span>.</p>
</div>
<section id="weak-formulations-of-the-navier-stokes-equation">
<h3><a class="toc-backref" href="#id3" role="doc-backlink">Weak formulations of the Navier-Stokes equation</a><a class="headerlink" href="#weak-formulations-of-the-navier-stokes-equation" title="Link to this heading"></a></h3>
<p>For the weak formulation we need choose the same function spaces
as in for Stokes and obtain:</p>
<div class="admonition-navier-stokes-equation-in-weak-formulation maths-equation admonition" id="maths-equation-1">
<p class="admonition-title">Navier-Stokes equation in weak formulation</p>
<p>Find <span class="math notranslate nohighlight">\(\mathbf{u}\in\mathbf{X}+\mathbf{g}_D, p\in Y\)</span>
such that:</p>
<div class="math notranslate nohighlight">
\[\begin{split}&amp;(\partial_t \mathbf{u},\mathbf{v})
 + \nu(\nabla_x {\mathbf{u}},\nabla_x \mathbf{v})
 +(\mathbf{u}\cdot\nabla_x\mathbf{u},\mathbf{v})\\
 &amp;- (p,\nabla_x\cdot \mathbf{v})
 + (\nabla_x\cdot\mathbf{u},q) = 0\\
&amp;\mathbf{u}(0,x) = \mathbf{u}^0(x) \text{ in }\Omega\end{split}\]</div>
</div>
<p>As in step-1 we allow for discontinuities between two temporal elements
in the function space for <span class="math notranslate nohighlight">\(\bf{u}\)</span> and obtain:</p>
<div class="admonition-stokes-equation-in-discontinuous-weak-formulation maths-equation admonition" id="maths-equation-2">
<p class="admonition-title">Stokes equation in discontinuous weak formulation</p>
<p>Find <span class="math notranslate nohighlight">\(\mathbf{u}\in\widetilde{\mathbf{X}}+\mathbf{g}_D, p\in Y\)</span>
such that:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\sum\limits_{m=1}^M &amp;(\partial_t \bf{u},\bf{v})_{I_m\times\Omega}
+ \nu(\nabla_x {\bf{u}},\nabla_x \bf{v})_{I_m\times\Omega}
+ (\mathbf{u}\cdot\nabla_x\mathbf{u},\mathbf{v})_{I_m\times\Omega}\\
&amp;- (p,\nabla_x\cdot \bf{v})_{I_m\times\Omega}
+(\nabla_x\cdot\bf{u},q)_{I_m\times\Omega} \\
\sum\limits_{m=0}^M &amp;+ ([\mathbf{u}]_m,\mathbf{v}_m^+)_{I_m\times\Omega}= 0\end{split}\]</div>
</div>
<p>For the temporal discretization we do the same steps as before
and for the spatial discretization we have to use inf-sup stable element
combinations. The simplest of these is the Q2/Q1 Taylor-Hood element
with biquadratic elements for the velocity and bilinear elements for
the pressure.</p>
</section>
<section id="problem-statement">
<h3><a class="toc-backref" href="#id4" role="doc-backlink">Problem statement</a><a class="headerlink" href="#problem-statement" title="Link to this heading"></a></h3>
<p>Now we actually solve the 2D-3 benchmark problem from <a class="reference internal" href="step-2.html#turschaben1996" id="id1"><span>[TurSchaBen1996]</span></a>.
The problem describes laminar flow of a fluid through a channel with a cylindrical
obstacle, as shown in the following image:</p>
<img alt="../_images/channel_domain.svg" src="../_images/channel_domain.svg" />
<p>For the pressure we prescribe homogeneous Neumann conditions
on all  boundaries and for the velocity we prescribe the following:</p>
<ul class="simple">
<li><p>A parabolic velocity profile on the inflow <span class="math notranslate nohighlight">\(\Gamma_\text{in}\)</span></p></li>
<li><p>no-slip,i.e. homogeneous Dirichlet conditon on the obstacle
<span class="math notranslate nohighlight">\(\Gamma_\text{circle}\)</span> and channel walls <span class="math notranslate nohighlight">\(\Gamma_\text{wall}\)</span></p></li>
<li><p>A homogeneous Neumann condition on the outflow <span class="math notranslate nohighlight">\(\Gamma_\text{out}\)</span></p></li>
</ul>
<p>We scale the inflow condition by a sine functions along the
temporal domain <span class="math notranslate nohighlight">\(I=(0,8)\)</span> and obtain</p>
<div class="math notranslate nohighlight">
\[\begin{split}\mathbf{u}_x &amp;= \sin(\pi t/8)(6y(H-y))/(H^2)\\
\mathbf{u}_y &amp;= 0\end{split}\]</div>
<p>with channel height <span class="math notranslate nohighlight">\(H=0.41\)</span>.</p>
<p>Since this is a benchmark problem there are functional values we can compute to
compare the results to other software packages.</p>
<p>We are going to calculate the temporal curves of the pressure at the
front and back of the obstacle, i.e. at <span class="math notranslate nohighlight">\(p(t,(0.15,0.1))\)</span> and <span class="math notranslate nohighlight">\(p(t,(0.15,0.2))\)</span>,
their difference and the drag and lift coefficients</p>
<div class="math notranslate nohighlight">
\[C_D(t) = \frac{2}{U^2L}F_D(t),\quad C_D(t) = \frac{2}{U^2L}F_L(t).\]</div>
<p>For this exact configuration the factor is <span class="math notranslate nohighlight">\(\frac{2}{H^2L}=20\)</span>.
The drag and lift forces <span class="math notranslate nohighlight">\(F_D(t)\)</span> and <span class="math notranslate nohighlight">\(F_L(t)\)</span> around the
cylinder are defined by</p>
<div class="math notranslate nohighlight">
\[\begin{split}F_D(t) = \int_{\Gamma_\text{circle}} (-p(t)I+
\nu\nabla \mathbf{v}(t))\cdot \mathbf{n}\cdot \mathbf{e}_1\mathrm{d}s\\
F_L(t) = \int_{\Gamma_\text{circle}} (-p(t)I+
\nu\nabla \mathbf{v}(t))\cdot \mathbf{n}\cdot \mathbf{e}_2\mathrm{d}s\end{split}\]</div>
</section>
</section>
<section id="the-commented-program">
<h2><a class="toc-backref" href="#id5" role="doc-backlink">The commented program</a><a class="headerlink" href="#the-commented-program" title="Link to this heading"></a></h2>
<section id="include-files">
<h3><a class="toc-backref" href="#id6" role="doc-backlink">include files</a><a class="headerlink" href="#include-files" title="Link to this heading"></a></h3>
<p>Compared to step-2 for coupled problems and step-3 for MPI-parallel linear
algebra with Trilinos, there are no new includes in this tutorial step.</p>
<section id="ideal-ii-includes">
<h4><a class="toc-backref" href="#id7" role="doc-backlink">ideal.II includes</a><a class="headerlink" href="#ideal-ii-includes" title="Link to this heading"></a></h4>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ideal.II/base/quadrature_lib.hh&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ideal.II/base/time_iterator.hh&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ideal.II/distributed/fixed_tria.hh&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ideal.II/dofs/slab_dof_tools.hh&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ideal.II/dofs/spacetime_dof_handler.hh&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ideal.II/fe/fe_dg.hh&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ideal.II/fe/spacetime_fe_values.hh&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ideal.II/lac/spacetime_trilinos_vector.hh&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ideal.II/numerics/vector_tools.hh&gt;</span>
</pre></div>
</div>
</section>
<section id="deal-ii-includes">
<h4><a class="toc-backref" href="#id8" role="doc-backlink">deal.II includes</a><a class="headerlink" href="#deal-ii-includes" title="Link to this heading"></a></h4>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/base/conditional_ostream.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/base/function.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/distributed/tria.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/fe/fe_q.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/fe/fe_system.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/grid/grid_in.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/grid/grid_tools.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/grid/manifold_lib.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/lac/dynamic_sparsity_pattern.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/lac/full_matrix.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/lac/sparse_direct.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/lac/sparsity_tools.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/lac/trilinos_solver.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/lac/trilinos_sparse_matrix.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/lac/trilinos_vector.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/lac/vector.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/numerics/data_out.h&gt;</span>
</pre></div>
</div>
</section>
<section id="trilinos-and-c-includes">
<h4><a class="toc-backref" href="#id9" role="doc-backlink">Trilinos and C++ includes</a><a class="headerlink" href="#trilinos-and-c-includes" title="Link to this heading"></a></h4>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Teuchos_CommandLineProcessor.hpp&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;fstream&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>
</pre></div>
</div>
</section>
</section>
<section id="space-time-functions">
<h3><a class="toc-backref" href="#id10" role="doc-backlink">Space-time functions</a><a class="headerlink" href="#space-time-functions" title="Link to this heading"></a></h3>
<p>The inflow condition is the same as in step-2</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">PoisseuilleInflow</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Function</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="n">PoisseuilleInflow</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">max_inflow_velocity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.5</span><span class="p">,</span>
<span class="w">                    </span><span class="kt">double</span><span class="w"> </span><span class="n">channel_height</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mf">0.41</span><span class="p">)</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">Function</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">max_inflow_velocity</span><span class="p">(</span><span class="n">max_inflow_velocity</span><span class="p">)</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">H</span><span class="p">(</span><span class="n">channel_height</span><span class="p">)</span>
<span class="w">  </span><span class="p">{}</span>

<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="kt">double</span>
<span class="w">  </span><span class="n">value</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Point</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span>
<span class="w">  </span><span class="nf">vector_value</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Point</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">max_inflow_velocity</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">H</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">double</span>
<span class="nf">PoisseuilleInflow::value</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Point</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span>
<span class="w">                         </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">      </span><span class="n">component</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">Assert</span><span class="p">(</span><span class="n">component</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">n_components</span><span class="p">,</span>
<span class="w">         </span><span class="n">dealii</span><span class="o">::</span><span class="n">ExcIndexRange</span><span class="p">(</span><span class="n">component</span><span class="p">,</span>
<span class="w">                               </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                               </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">n_components</span><span class="p">))</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">component</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.41</span><span class="p">)</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_time</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">max_inflow_velocity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">H</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">               </span><span class="n">std</span><span class="o">::</span><span class="n">sin</span><span class="p">(</span><span class="n">M_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.125</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">H</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">H</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">PoisseuilleInflow::vector_value</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Point</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span>
<span class="w">                                </span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">values</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">n_components</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">values</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="the-step4-class">
<h3><a class="toc-backref" href="#id11" role="doc-backlink">The Step4 class</a><a class="headerlink" href="#the-step4-class" title="Link to this heading"></a></h3>
<p>This class describes the solution of the nonlinear Navier-Stokes equations
with space-time slab tensor-product elements and a Newton linearization.
Compared to earlier steps we have a few new functions
We split the assembly into matrix and right hand side, as we have to call the
latter more frequently in the Newton algorithm.
Additionally, we now have functions to calculate the functionals,
i.e. pressure as well as drag and lift.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="k">class</span><span class="w"> </span><span class="nc">Step4</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="n">Step4</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">temporal_degree</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">write_vtu</span><span class="p">);</span>
<span class="w">  </span><span class="kt">void</span>
<span class="w">  </span><span class="nf">run</span><span class="p">();</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">  </span><span class="kt">void</span>
<span class="w">  </span><span class="n">make_grid</span><span class="p">();</span>
<span class="w">  </span><span class="kt">void</span>
<span class="w">  </span><span class="nf">time_marching</span><span class="p">();</span>
<span class="w">  </span><span class="kt">void</span>
<span class="w">  </span><span class="nf">setup_system_on_slab</span><span class="p">();</span>
<span class="w">  </span><span class="kt">void</span>
<span class="w">  </span><span class="nf">assemble_residual_on_slab</span><span class="p">();</span>
<span class="w">  </span><span class="kt">void</span>
<span class="w">  </span><span class="nf">assemble_system_on_slab</span><span class="p">();</span>
<span class="w">  </span><span class="kt">void</span>
<span class="w">  </span><span class="nf">solve_Newton_problem_on_slab</span><span class="p">();</span>
<span class="w">  </span><span class="kt">void</span>
<span class="w">  </span><span class="nf">calculate_functional_values_on_slab</span><span class="p">();</span>
<span class="w">  </span><span class="kt">double</span>
<span class="w">  </span><span class="nf">calculate_pressure_at_point</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Point</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w">                       </span><span class="n">x</span><span class="p">,</span>
<span class="w">                              </span><span class="k">const</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">Vector</span><span class="w"> </span><span class="o">&amp;</span><span class="n">u</span><span class="p">);</span>
<span class="w">  </span><span class="kt">void</span>
<span class="w">  </span><span class="nf">calculate_drag_lift_tensor</span><span class="p">(</span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">Vector</span><span class="w"> </span><span class="o">&amp;</span><span class="n">u</span><span class="p">,</span>
<span class="w">                             </span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">drag_lift_value</span><span class="p">);</span>

<span class="w">  </span><span class="kt">void</span>
<span class="w">  </span><span class="nf">output_results_on_slab</span><span class="p">();</span>

<span class="w">  </span><span class="n">MPI_Comm</span><span class="w"> </span><span class="n">mpi_comm</span><span class="p">;</span><span class="w"> </span><span class="c1">// MPI communicator</span>
<span class="w">  </span><span class="kt">bool</span><span class="w">     </span><span class="n">write_vtu</span><span class="p">;</span>
</pre></div>
</div>
<p>We want to write out the temporal trend of the functional values
into a file and for that log we need to construct a name as well.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">ofstream</span><span class="w">      </span><span class="n">functional_log</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">ostringstream</span><span class="w"> </span><span class="n">logname</span><span class="p">;</span>
</pre></div>
</div>
<p>We need the kinematic viscosity at multiple spots so we add it as a member
variable to ensure consistency.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">nu_f</span><span class="p">;</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">ConditionalOStream</span><span class="w"> </span><span class="n">pout</span><span class="p">;</span>

<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">spacetime</span><span class="o">::</span><span class="n">parallel</span><span class="o">::</span><span class="n">distributed</span><span class="o">::</span><span class="n">fixed</span><span class="o">::</span><span class="n">Triangulation</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span>
<span class="w">                                     </span><span class="n">triangulation</span><span class="p">;</span>
<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">spacetime</span><span class="o">::</span><span class="n">DoFHandler</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w">  </span><span class="n">dof_handler</span><span class="p">;</span>
<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">spacetime</span><span class="o">::</span><span class="n">TrilinosVector</span><span class="w"> </span><span class="n">solution</span><span class="p">;</span>

<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">spacetime</span><span class="o">::</span><span class="n">DG_FiniteElement</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fe</span><span class="p">;</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">SparsityPattern</span><span class="w">                            </span><span class="n">slab_sparsity_pattern</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">AffineConstraints</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">slab_zero_constraints</span><span class="p">;</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">SparseMatrix</span><span class="w">             </span><span class="n">slab_system_matrix</span><span class="p">;</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">Vector</span><span class="w">              </span><span class="n">slab_system_rhs</span><span class="p">;</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">Vector</span><span class="w">              </span><span class="n">slab_initial_value</span><span class="p">;</span>
<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">                                       </span><span class="n">slab</span><span class="p">;</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">Vector</span><span class="w"> </span><span class="n">slab_newton_update</span><span class="p">;</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">Vector</span><span class="w"> </span><span class="n">slab_owned_tmp</span><span class="p">;</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">Vector</span><span class="w"> </span><span class="n">slab_relevant_tmp</span><span class="p">;</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">IndexSet</span><span class="w"> </span><span class="n">slab_locally_owned_dofs</span><span class="p">;</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">IndexSet</span><span class="w"> </span><span class="n">slab_locally_relevant_dofs</span><span class="p">;</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">IndexSet</span><span class="w"> </span><span class="n">space_locally_owned_dofs</span><span class="p">;</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">IndexSet</span><span class="w"> </span><span class="n">space_locally_relevant_dofs</span><span class="p">;</span>

<span class="w">  </span><span class="k">struct</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">idealii</span><span class="o">::</span><span class="n">slab</span><span class="o">::</span><span class="n">parallel</span><span class="o">::</span><span class="n">distributed</span><span class="o">::</span><span class="n">TriaIterator</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tria</span><span class="p">;</span>
<span class="w">    </span><span class="n">idealii</span><span class="o">::</span><span class="n">slab</span><span class="o">::</span><span class="n">DoFHandlerIterator</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w">                  </span><span class="n">dof</span><span class="p">;</span>
<span class="w">    </span><span class="n">idealii</span><span class="o">::</span><span class="n">slab</span><span class="o">::</span><span class="n">TrilinosVectorIterator</span><span class="w">                 </span><span class="n">solution</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="n">slab_its</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>
</div>
<section id="step4-step4">
<h4><a class="toc-backref" href="#id12" role="doc-backlink">Step4::Step4</a><a class="headerlink" href="#step4-step4" title="Link to this heading"></a></h4>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="n">Step4</span><span class="o">::</span><span class="n">Step4</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">temporal_degree</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">write_vtu</span><span class="p">)</span>
<span class="w">  </span><span class="o">:</span><span class="w"> </span><span class="n">mpi_comm</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">)</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">write_vtu</span><span class="p">(</span><span class="n">write_vtu</span><span class="p">)</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">nu_f</span><span class="p">(</span><span class="mf">1.0e-3</span><span class="p">)</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">pout</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">,</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Utilities</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">this_mpi_process</span><span class="p">(</span><span class="n">mpi_comm</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">triangulation</span><span class="p">()</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">dof_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">triangulation</span><span class="p">)</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">fe</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">FESystem</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">dealii</span><span class="o">::</span><span class="n">FE_Q</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
<span class="w">                                             </span><span class="mi">2</span><span class="p">,</span>
<span class="w">                                             </span><span class="n">dealii</span><span class="o">::</span><span class="n">FE_Q</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
<span class="w">                                             </span><span class="mi">1</span><span class="p">),</span>
<span class="w">       </span><span class="n">temporal_degree</span><span class="p">,</span>
<span class="w">       </span><span class="n">idealii</span><span class="o">::</span><span class="n">spacetime</span><span class="o">::</span><span class="n">DG_FiniteElement</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;::</span><span class="n">support_type</span><span class="o">::</span><span class="n">Legendre</span><span class="p">)</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">slab</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">{</span>
</pre></div>
</div>
<p>This is the easiest place to add the temporal degree
to the filename of the functional log, so we do that.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">logname</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;functional_log_dG&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">temporal_degree</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="step4-run">
<h4><a class="toc-backref" href="#id13" role="doc-backlink">Step4::run</a><a class="headerlink" href="#step4-run" title="Link to this heading"></a></h4>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="nf">Step4::run</span><span class="p">()</span><span class="w"> </span><span class="c1">// same as before</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">make_grid</span><span class="p">();</span>
<span class="w">  </span><span class="n">time_marching</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="step4-make-grid">
<h4><a class="toc-backref" href="#id14" role="doc-backlink">Step4::make_grid</a><a class="headerlink" href="#step4-make-grid" title="Link to this heading"></a></h4>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="nf">Step4::make_grid</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">space_tria</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="c1">// construct an MPI parallel triangulation</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">parallel</span><span class="o">::</span><span class="n">distributed</span><span class="o">::</span><span class="n">Triangulation</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">mpi_comm</span><span class="p">);</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">GridIn</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">grid_in</span><span class="p">;</span>
<span class="w">  </span><span class="n">grid_in</span><span class="p">.</span><span class="n">attach_triangulation</span><span class="p">(</span><span class="o">*</span><span class="n">space_tria</span><span class="p">);</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">ifstream</span><span class="w"> </span><span class="n">input_file</span><span class="p">(</span><span class="s">&quot;nsbench4.inp&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">grid_in</span><span class="p">.</span><span class="n">read_ucd</span><span class="p">(</span><span class="n">input_file</span><span class="p">);</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Point</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w">                          </span><span class="n">p</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span><span class="w"> </span><span class="mf">0.2</span><span class="p">);</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">SphericalManifold</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">boundary</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">GridTools</span><span class="o">::</span><span class="n">copy_boundary_to_manifold_id</span><span class="p">(</span><span class="o">*</span><span class="n">space_tria</span><span class="p">);</span>
<span class="w">  </span><span class="n">space_tria</span><span class="o">-&gt;</span><span class="n">set_manifold</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span><span class="w"> </span><span class="n">boundary</span><span class="p">);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span>
<span class="w">  </span><span class="n">triangulation</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="n">space_tria</span><span class="p">,</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">8.</span><span class="p">);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n_ref_space</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">  </span><span class="n">triangulation</span><span class="p">.</span><span class="n">refine_global</span><span class="p">(</span><span class="n">n_ref_space</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="n">dof_handler</span><span class="p">.</span><span class="n">generate</span><span class="p">();</span>
</pre></div>
</div>
<p>To have the full information in the log we also add the number of
temporal DoFs and the number of spatial refinements to the
filename.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">logname</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;_M&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;_lvl&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">n_ref_space</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;.csv&quot;</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="step4-time-marching">
<h4><a class="toc-backref" href="#id15" role="doc-backlink">Step4::time_marching</a><a class="headerlink" href="#step4-time-marching" title="Link to this heading"></a></h4>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="nf">Step4::time_marching</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">TimeIteratorCollection</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idealii</span><span class="o">::</span><span class="n">TimeIteratorCollection</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">();</span>

<span class="w">  </span><span class="n">solution</span><span class="p">.</span><span class="n">reinit</span><span class="p">(</span><span class="n">triangulation</span><span class="p">.</span><span class="n">M</span><span class="p">());</span>

<span class="w">  </span><span class="n">slab_its</span><span class="p">.</span><span class="n">tria</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">triangulation</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
<span class="w">  </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">dof_handler</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
<span class="w">  </span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">solution</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
<span class="w">  </span><span class="n">slab</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="n">tic</span><span class="p">.</span><span class="n">add_iterator</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slab_its</span><span class="p">.</span><span class="n">tria</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">triangulation</span><span class="p">);</span>
<span class="w">  </span><span class="n">tic</span><span class="p">.</span><span class="n">add_iterator</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dof_handler</span><span class="p">);</span>
<span class="w">  </span><span class="n">tic</span><span class="p">.</span><span class="n">add_iterator</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">solution</span><span class="p">);</span>
</pre></div>
</div>
<p>We don’t want to write each time DoF information multiple times,
so we only open the file on rank 0.
We also write out a header for the CSV file so it is clear
which column will be which variable.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dealii</span><span class="o">::</span><span class="n">Utilities</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">this_mpi_process</span><span class="p">(</span><span class="n">mpi_comm</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Opening functional log file: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">logname</span><span class="p">.</span><span class="n">str</span><span class="p">()</span>
<span class="w">                </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">      </span><span class="n">functional_log</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">logname</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
<span class="w">      </span><span class="n">functional_log</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;t, pfront, pback, pdiff, drag, lift&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">  </span><span class="n">pout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;*******Starting time-stepping*********&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(;</span><span class="w"> </span><span class="o">!</span><span class="n">tic</span><span class="p">.</span><span class="n">at_end</span><span class="p">();</span><span class="w"> </span><span class="n">tic</span><span class="p">.</span><span class="n">increment</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">pout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Starting time-step (&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">tria</span><span class="o">-&gt;</span><span class="n">startpoint</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;,&quot;</span>
<span class="w">           </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">tria</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

<span class="w">      </span><span class="n">setup_system_on_slab</span><span class="p">();</span>
</pre></div>
</div>
<p>As the system matrix for a nonlinear problem depends on the
approximate solution, the assembly is done within the Newton
iterations.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">      </span><span class="n">solve_Newton_problem_on_slab</span><span class="p">();</span>

<span class="w">      </span><span class="n">calculate_functional_values_on_slab</span><span class="p">();</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">write_vtu</span><span class="p">)</span>
<span class="w">        </span><span class="n">output_results_on_slab</span><span class="p">();</span>
</pre></div>
</div>
<p>As in step-3 we need to extract the solution at the final time point as
the final DoF is not in the same location for the chosen
Legendre support points.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">      </span><span class="n">idealii</span><span class="o">::</span><span class="n">slab</span><span class="o">::</span><span class="n">VectorTools</span><span class="o">::</span><span class="n">extract_subvector_at_time_point</span><span class="p">(</span>
<span class="w">        </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="p">,</span>
<span class="w">        </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="p">,</span>
<span class="w">        </span><span class="n">slab_initial_value</span><span class="p">,</span>
<span class="w">        </span><span class="n">slab_its</span><span class="p">.</span><span class="n">tria</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">());</span>
<span class="w">      </span><span class="n">slab</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dealii</span><span class="o">::</span><span class="n">Utilities</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">this_mpi_process</span><span class="p">(</span><span class="n">mpi_comm</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">functional_log</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="step4-setup-system-on-slab">
<h4><a class="toc-backref" href="#id16" role="doc-backlink">Step4::setup_system_on_slab</a><a class="headerlink" href="#step4-setup-system-on-slab" title="Link to this heading"></a></h4>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="nf">Step4::setup_system_on_slab</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">distribute_dofs</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>
</pre></div>
</div>
<p>If we renumber we get a problem with parallel data output,
so we omit that here!</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">pout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Number of degrees of freedom: </span><span class="se">\n\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">n_dofs_space</span><span class="p">()</span>
<span class="w">       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; (space) * &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">n_dofs_time</span><span class="p">()</span>
<span class="w">       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; (time) = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">n_dofs_spacetime</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</pre></div>
</div>
<p>As in step-3 we need to know which DoFs are owned by the current MPI rank
and which are ghost points beloging to a different rank but are also part
of an owned spatial element.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">space_locally_owned_dofs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">spatial</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">locally_owned_dofs</span><span class="p">();</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">DoFTools</span><span class="o">::</span><span class="n">extract_locally_relevant_dofs</span><span class="p">(</span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">spatial</span><span class="p">(),</span>
<span class="w">                                                  </span><span class="n">space_locally_relevant_dofs</span><span class="p">);</span>

<span class="w">  </span><span class="n">slab_locally_owned_dofs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">locally_owned_dofs</span><span class="p">();</span>
<span class="w">  </span><span class="n">slab_locally_relevant_dofs</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">idealii</span><span class="o">::</span><span class="n">slab</span><span class="o">::</span><span class="n">DoFTools</span><span class="o">::</span><span class="n">extract_locally_relevant_dofs</span><span class="p">(</span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="p">);</span>

<span class="w">  </span><span class="n">slab_owned_tmp</span><span class="p">.</span><span class="n">reinit</span><span class="p">(</span><span class="n">slab_locally_owned_dofs</span><span class="p">,</span><span class="w"> </span><span class="n">mpi_comm</span><span class="p">);</span>
<span class="w">  </span><span class="n">slab_relevant_tmp</span><span class="p">.</span><span class="n">reinit</span><span class="p">(</span><span class="n">slab_locally_owned_dofs</span><span class="p">,</span>
<span class="w">                           </span><span class="n">slab_locally_relevant_dofs</span><span class="p">,</span>
<span class="w">                           </span><span class="n">mpi_comm</span><span class="p">);</span>
<span class="w">  </span><span class="n">slab_newton_update</span><span class="p">.</span><span class="n">reinit</span><span class="p">(</span><span class="n">slab_locally_owned_dofs</span><span class="p">,</span><span class="w"> </span><span class="n">mpi_comm</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">slab</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">slab_initial_value</span><span class="p">.</span><span class="n">reinit</span><span class="p">(</span><span class="n">space_locally_owned_dofs</span><span class="p">,</span>
<span class="w">                                </span><span class="n">space_locally_relevant_dofs</span><span class="p">,</span>
<span class="w">                                </span><span class="n">mpi_comm</span><span class="p">);</span>
<span class="w">      </span><span class="n">slab_initial_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
<p>We need two sets of constraints for the defect correction Newton method.
The Newton updates will be added to the current solution in each step.
So in order to leave the boundary conditions of the solution unchanged,
the update will need to have zero Dirichlet boundary conditions.
Consequently, the initial guess will need to have correct boundary
conditions.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">slab_zero_constraints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">AffineConstraints</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&gt;</span><span class="p">();</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">slab_initial_constraints</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">AffineConstraints</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&gt;</span><span class="p">();</span>
<span class="w">  </span><span class="k">auto</span><span class="w">              </span><span class="n">zero</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Functions</span><span class="o">::</span><span class="n">ZeroFunction</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="w">  </span><span class="k">auto</span><span class="w">              </span><span class="n">inflow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PoisseuilleInflow</span><span class="p">();</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">component_mask</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">  </span><span class="n">component_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">slab</span><span class="o">::</span><span class="n">VectorTools</span><span class="o">::</span><span class="n">interpolate_boundary_values</span><span class="p">(</span>
<span class="w">    </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">inflow</span><span class="p">,</span><span class="w"> </span><span class="n">slab_initial_constraints</span><span class="p">,</span><span class="w"> </span><span class="n">component_mask</span><span class="p">);</span>

<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">slab</span><span class="o">::</span><span class="n">VectorTools</span><span class="o">::</span><span class="n">interpolate_boundary_values</span><span class="p">(</span>
<span class="w">    </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="n">slab_initial_constraints</span><span class="p">,</span><span class="w"> </span><span class="n">component_mask</span><span class="p">);</span>

<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">slab</span><span class="o">::</span><span class="n">VectorTools</span><span class="o">::</span><span class="n">interpolate_boundary_values</span><span class="p">(</span>
<span class="w">    </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="p">,</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="n">slab_initial_constraints</span><span class="p">,</span><span class="w"> </span><span class="n">component_mask</span><span class="p">);</span>

<span class="w">  </span><span class="n">slab_initial_constraints</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">();</span>

<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">slab</span><span class="o">::</span><span class="n">VectorTools</span><span class="o">::</span><span class="n">interpolate_boundary_values</span><span class="p">(</span>
<span class="w">    </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="n">slab_zero_constraints</span><span class="p">,</span><span class="w"> </span><span class="n">component_mask</span><span class="p">);</span>

<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">slab</span><span class="o">::</span><span class="n">VectorTools</span><span class="o">::</span><span class="n">interpolate_boundary_values</span><span class="p">(</span>
<span class="w">    </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="n">slab_zero_constraints</span><span class="p">,</span><span class="w"> </span><span class="n">component_mask</span><span class="p">);</span>

<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">slab</span><span class="o">::</span><span class="n">VectorTools</span><span class="o">::</span><span class="n">interpolate_boundary_values</span><span class="p">(</span>
<span class="w">    </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="p">,</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="n">slab_zero_constraints</span><span class="p">,</span><span class="w"> </span><span class="n">component_mask</span><span class="p">);</span>

<span class="w">  </span><span class="n">slab_zero_constraints</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">();</span>
</pre></div>
</div>
<p>Since the Newton method is iterative we have to start with some initial
guess and the convergence speed depends on the closeness of the
current approximation to the correct solution.
Without prior knowledge this initial guess is often zero.
Here, however we know the solution at the last temporal DoF of the
previous slab and for a fine enough temporal mesh that should at least
be closer to the correct solution than zero and so we choose that
and only correct the guess at the Dirichlet boundaries.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">IndexSet</span><span class="o">::</span><span class="n">ElementIterator</span><span class="w"> </span><span class="n">lri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">space_locally_owned_dofs</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">IndexSet</span><span class="o">::</span><span class="n">ElementIterator</span><span class="w"> </span><span class="n">lre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">space_locally_owned_dofs</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(;</span><span class="w"> </span><span class="n">lri</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">lre</span><span class="p">;</span><span class="w"> </span><span class="n">lri</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">n_dofs_time</span><span class="p">();</span><span class="w"> </span><span class="n">ii</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="n">slab_owned_tmp</span><span class="p">[</span><span class="o">*</span><span class="n">lri</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">n_dofs_space</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ii</span><span class="p">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">slab_initial_value</span><span class="p">[</span><span class="o">*</span><span class="n">lri</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="n">slab_initial_constraints</span><span class="o">-&gt;</span><span class="n">distribute</span><span class="p">(</span><span class="n">slab_owned_tmp</span><span class="p">);</span>
</pre></div>
</div>
<p>The spatial pressure-pressure coupling block is empty
and the sparsity pattern can be empty in these blocks as in step-2.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Table</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">DoFTools</span><span class="o">::</span><span class="n">Coupling</span><span class="o">&gt;</span><span class="w"> </span><span class="n">coupling_space</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">coupling_space</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">DoFTools</span><span class="o">::</span><span class="n">always</span><span class="p">;</span>
<span class="w">      </span><span class="n">coupling_space</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">DoFTools</span><span class="o">::</span><span class="n">always</span><span class="p">;</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="n">coupling_space</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">DoFTools</span><span class="o">::</span><span class="n">always</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">DynamicSparsityPattern</span><span class="w"> </span><span class="n">dsp</span><span class="p">(</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">n_dofs_spacetime</span><span class="p">());</span>
<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">slab</span><span class="o">::</span><span class="n">DoFTools</span><span class="o">::</span><span class="n">make_upwind_sparsity_pattern</span><span class="p">(</span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="p">,</span>
<span class="w">                                                        </span><span class="n">coupling_space</span><span class="p">,</span>
<span class="w">                                                        </span><span class="n">dsp</span><span class="p">,</span>
<span class="w">                                                        </span><span class="n">slab_zero_constraints</span><span class="p">);</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">SparsityTools</span><span class="o">::</span><span class="n">distribute_sparsity_pattern</span><span class="p">(</span>
<span class="w">    </span><span class="n">dsp</span><span class="p">,</span><span class="w"> </span><span class="n">slab_locally_owned_dofs</span><span class="p">,</span><span class="w"> </span><span class="n">mpi_comm</span><span class="p">,</span><span class="w"> </span><span class="n">slab_locally_relevant_dofs</span><span class="p">);</span>


<span class="w">  </span><span class="n">slab_system_matrix</span><span class="p">.</span><span class="n">reinit</span><span class="p">(</span><span class="n">slab_locally_owned_dofs</span><span class="p">,</span>
<span class="w">                            </span><span class="n">slab_locally_owned_dofs</span><span class="p">,</span>
<span class="w">                            </span><span class="n">dsp</span><span class="p">);</span>

<span class="w">  </span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="o">-&gt;</span><span class="n">reinit</span><span class="p">(</span><span class="n">slab_locally_owned_dofs</span><span class="p">,</span>
<span class="w">                            </span><span class="n">slab_locally_relevant_dofs</span><span class="p">,</span>
<span class="w">                            </span><span class="n">mpi_comm</span><span class="p">);</span>
<span class="w">  </span><span class="n">slab_system_rhs</span><span class="p">.</span><span class="n">reinit</span><span class="p">(</span><span class="n">slab_locally_owned_dofs</span><span class="p">,</span><span class="w"> </span><span class="n">mpi_comm</span><span class="p">);</span>
<span class="w">  </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slab_owned_tmp</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="step4-assemble-system-on-slab">
<h4><a class="toc-backref" href="#id17" role="doc-backlink">Step4::assemble_system_on_slab</a><a class="headerlink" href="#step4-assemble-system-on-slab" title="Link to this heading"></a></h4>
<p>In contrast to previous steps we only assemble the matrix here.
This is because we have to assemble the right hand side, i.e. Newton residual
more often.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="nf">Step4::assemble_system_on_slab</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">slab_system_matrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
</pre></div>
</div>
<p>We use a higher spatial quadrature order, since the nonlinear convection
term is of higher order.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">spacetime</span><span class="o">::</span><span class="n">QGauss</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">quad</span><span class="p">(</span><span class="n">fe</span><span class="p">.</span><span class="n">spatial</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">degree</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<span class="w">                                     </span><span class="n">fe</span><span class="p">.</span><span class="n">temporal</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">degree</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>

<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">spacetime</span><span class="o">::</span><span class="n">FEValues</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fe_values_spacetime</span><span class="p">(</span>
<span class="w">    </span><span class="n">fe</span><span class="p">,</span>
<span class="w">    </span><span class="n">quad</span><span class="p">,</span>
<span class="w">    </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_values</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_gradients</span><span class="w"> </span><span class="o">|</span>
<span class="w">      </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_quadrature_points</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_JxW_values</span><span class="p">);</span>

<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">spacetime</span><span class="o">::</span><span class="n">FEJumpValues</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fe_jump_values_spacetime</span><span class="p">(</span>
<span class="w">    </span><span class="n">fe</span><span class="p">,</span>
<span class="w">    </span><span class="n">quad</span><span class="p">,</span>
<span class="w">    </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_values</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_gradients</span><span class="w"> </span><span class="o">|</span>
<span class="w">      </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_quadrature_points</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_JxW_values</span><span class="p">);</span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fe</span><span class="p">.</span><span class="n">dofs_per_cell</span><span class="p">;</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">tria</span><span class="o">-&gt;</span><span class="n">temporal</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">n_global_active_cells</span><span class="p">();</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">FullMatrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cell_matrix</span><span class="p">(</span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">,</span>
<span class="w">                                         </span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">);</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">types</span><span class="o">::</span><span class="n">global_dof_index</span><span class="o">&gt;</span><span class="w"> </span><span class="n">local_spacetime_dof_index</span><span class="p">(</span>
<span class="w">    </span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">);</span>

<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n_quad_spacetime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">n_quadrature_points</span><span class="p">;</span>
<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n_quad_space</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">quad</span><span class="p">.</span><span class="n">spatial</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">FEValuesExtractors</span><span class="o">::</span><span class="n">Vector</span><span class="w"> </span><span class="nf">velocity</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">FEValuesExtractors</span><span class="o">::</span><span class="n">Scalar</span><span class="w"> </span><span class="nf">pressure</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</pre></div>
</div>
<p>The convection term includes the previous Newton iterate and its
derivative, so we have to allocate storage to evaluate the iterate at each
quadrature point.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">old_solution_values</span><span class="p">(</span>
<span class="w">    </span><span class="n">n_quad_spacetime</span><span class="p">,</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="n">old_solution_grads</span><span class="p">(</span>
<span class="w">    </span><span class="n">n_quad_spacetime</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cell_space</span><span class="w"> </span><span class="o">:</span>
<span class="w">       </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">spatial</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">active_cell_iterators</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cell_space</span><span class="o">-&gt;</span><span class="n">is_locally_owned</span><span class="p">())</span><span class="w"> </span><span class="c1">// only rank local contributions</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">reinit_space</span><span class="p">(</span><span class="n">cell_space</span><span class="p">);</span>
<span class="w">          </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">reinit_space</span><span class="p">(</span><span class="n">cell_space</span><span class="p">);</span>

<span class="w">          </span><span class="n">cell_matrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cell_time</span><span class="w"> </span><span class="o">:</span>
<span class="w">               </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">temporal</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">active_cell_iterators</span><span class="p">())</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">              </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cell_time</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">();</span>
<span class="w">              </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">reinit_time</span><span class="p">(</span><span class="n">cell_time</span><span class="p">);</span>
<span class="w">              </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">reinit_time</span><span class="p">(</span><span class="n">cell_time</span><span class="p">);</span>
<span class="w">              </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">get_local_dof_indices</span><span class="p">(</span>
<span class="w">                </span><span class="n">local_spacetime_dof_index</span><span class="p">);</span>
</pre></div>
</div>
<p>evaluate the previous Newton iterate on the current space-time
element.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">              </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">get_function_values</span><span class="p">(</span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="p">,</span>
<span class="w">                                                      </span><span class="n">old_solution_values</span><span class="p">);</span>

<span class="w">              </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">get_function_space_gradients</span><span class="p">(</span>
<span class="w">                </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="p">,</span><span class="w"> </span><span class="n">old_solution_grads</span><span class="p">);</span>

<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_quad_spacetime</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">q</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
</pre></div>
</div>
<p>We save the previous Newton iterate at the current
quadrature point into more useful data structures for the
assembly.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">                  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">v</span><span class="p">;</span>
<span class="w">                  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">grad_v</span><span class="p">;</span>
<span class="w">                  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="o">++</span><span class="p">)</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                      </span><span class="n">v</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_solution_values</span><span class="p">[</span><span class="n">q</span><span class="p">](</span><span class="n">c</span><span class="p">);</span>
<span class="w">                      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="o">++</span><span class="p">)</span>
<span class="w">                        </span><span class="p">{</span>
<span class="w">                          </span><span class="n">grad_v</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">d</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_solution_grads</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">d</span><span class="p">];</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span>
<span class="w">                        </span><span class="p">{</span>
</pre></div>
</div>
<p>(convection term)</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">                          </span><span class="n">cell_matrix</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">,</span>
<span class="w">                                      </span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">)</span><span class="w"> </span><span class="o">+=</span>
<span class="w">                            </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">vector_value</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                            </span><span class="p">(</span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">vector_space_grad</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span>
<span class="w">                                                                   </span><span class="n">j</span><span class="p">,</span>
<span class="w">                                                                   </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                               </span><span class="n">v</span><span class="w"> </span><span class="o">+</span>
<span class="w">                             </span><span class="n">grad_v</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">vector_value</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span>
<span class="w">                                                                       </span><span class="n">j</span><span class="p">,</span>
<span class="w">                                                                       </span><span class="n">q</span><span class="p">))</span><span class="w"> </span><span class="o">*</span>
<span class="w">                            </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
</pre></div>
</div>
<p><span class="math notranslate nohighlight">\((\partial_t u,v)\)</span></p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">                          </span><span class="n">cell_matrix</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">,</span>
<span class="w">                                      </span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">)</span><span class="w"> </span><span class="o">+=</span>
<span class="w">                            </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">vector_value</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                            </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">vector_dt</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                            </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
</pre></div>
</div>
<p><span class="math notranslate nohighlight">\((\nabla u, \nabla v)\)</span></p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">                          </span><span class="n">cell_matrix</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">,</span>
<span class="w">                                      </span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">)</span><span class="w"> </span><span class="o">+=</span>
<span class="w">                            </span><span class="n">dealii</span><span class="o">::</span><span class="n">scalar_product</span><span class="p">(</span>
<span class="w">                              </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">vector_space_grad</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span>
<span class="w">                                                                    </span><span class="n">i</span><span class="p">,</span>
<span class="w">                                                                    </span><span class="n">q</span><span class="p">),</span>
<span class="w">                              </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">vector_space_grad</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span>
<span class="w">                                                                    </span><span class="n">j</span><span class="p">,</span>
<span class="w">                                                                    </span><span class="n">q</span><span class="p">))</span><span class="w"> </span><span class="o">*</span>
<span class="w">                            </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">nu_f</span><span class="p">;</span>
</pre></div>
</div>
<p><span class="math notranslate nohighlight">\(-(p,\nabla\cdot v)\)</span></p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">                          </span><span class="n">cell_matrix</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">,</span>
<span class="w">                                      </span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">)</span><span class="w"> </span><span class="o">-=</span>
<span class="w">                            </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">vector_divergence</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span>
<span class="w">                                                                  </span><span class="n">i</span><span class="p">,</span>
<span class="w">                                                                  </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                            </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">scalar_value</span><span class="p">(</span><span class="n">pressure</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                            </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
</pre></div>
</div>
<p><span class="math notranslate nohighlight">\((\nabla\cdot u,q)\)</span></p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">                          </span><span class="n">cell_matrix</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">,</span>
<span class="w">                                      </span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">)</span><span class="w"> </span><span class="o">+=</span>
<span class="w">                            </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">scalar_value</span><span class="p">(</span><span class="n">pressure</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                            </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">vector_divergence</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span>
<span class="w">                                                                  </span><span class="n">j</span><span class="p">,</span>
<span class="w">                                                                  </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                            </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

<span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="c1">// dofs j</span>

<span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="c1">// dofs i</span>

<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="c1">// quad</span>

<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_quad_space</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">q</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span>
<span class="w">                        </span><span class="p">{</span>
</pre></div>
</div>
<p>(u^+, v^+)</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">                          </span><span class="n">cell_matrix</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">,</span>
<span class="w">                                      </span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">)</span><span class="w"> </span><span class="o">+=</span>
<span class="w">                            </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">vector_value_plus</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span>
<span class="w">                                                                       </span><span class="n">i</span><span class="p">,</span>
<span class="w">                                                                       </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                            </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">vector_value_plus</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span>
<span class="w">                                                                       </span><span class="n">j</span><span class="p">,</span>
<span class="w">                                                                       </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                            </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
</pre></div>
</div>
<p>-(u^-, v^+)</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">                          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                            </span><span class="p">{</span>
<span class="w">                              </span><span class="n">cell_matrix</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">,</span>
<span class="w">                                          </span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                                                </span><span class="n">dofs_per_spacetime_cell</span><span class="p">)</span><span class="w"> </span><span class="o">-=</span>
<span class="w">                                </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">vector_value_plus</span><span class="p">(</span>
<span class="w">                                  </span><span class="n">velocity</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                                </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">vector_value_minus</span><span class="p">(</span>
<span class="w">                                  </span><span class="n">velocity</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                                </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
<span class="w">                            </span><span class="p">}</span>
<span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="c1">// dofs j</span>

<span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="c1">// dofs i</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="c1">// cell time</span>
<span class="w">          </span><span class="n">slab_zero_constraints</span><span class="o">-&gt;</span><span class="n">distribute_local_to_global</span><span class="p">(</span>
<span class="w">            </span><span class="n">cell_matrix</span><span class="p">,</span><span class="w"> </span><span class="n">local_spacetime_dof_index</span><span class="p">,</span><span class="w"> </span><span class="n">slab_system_matrix</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="c1">// cell space</span>

<span class="w">  </span><span class="n">slab_system_matrix</span><span class="p">.</span><span class="n">compress</span><span class="p">(</span><span class="n">dealii</span><span class="o">::</span><span class="n">VectorOperation</span><span class="o">::</span><span class="n">add</span><span class="p">);</span><span class="w"> </span><span class="c1">// communication</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="step4-assemble-residual-on-slab">
<h4><a class="toc-backref" href="#id18" role="doc-backlink">Step4::assemble_residual_on_slab</a><a class="headerlink" href="#step4-assemble-residual-on-slab" title="Link to this heading"></a></h4>
<p>For the Newton iteration we also need to assemble the residual vector
which also depends on the current slab solution/iterate.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="nf">Step4::assemble_residual_on_slab</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">slab_system_rhs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">spacetime</span><span class="o">::</span><span class="n">QGauss</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">quad</span><span class="p">(</span><span class="n">fe</span><span class="p">.</span><span class="n">spatial</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">degree</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<span class="w">                                     </span><span class="n">fe</span><span class="p">.</span><span class="n">temporal</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">degree</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>

<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">spacetime</span><span class="o">::</span><span class="n">FEValues</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fe_values_spacetime</span><span class="p">(</span>
<span class="w">    </span><span class="n">fe</span><span class="p">,</span>
<span class="w">    </span><span class="n">quad</span><span class="p">,</span>
<span class="w">    </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_values</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_gradients</span><span class="w"> </span><span class="o">|</span>
<span class="w">      </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_quadrature_points</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_JxW_values</span><span class="p">);</span>

<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">spacetime</span><span class="o">::</span><span class="n">FEJumpValues</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fe_jump_values_spacetime</span><span class="p">(</span>
<span class="w">    </span><span class="n">fe</span><span class="p">,</span>
<span class="w">    </span><span class="n">quad</span><span class="p">,</span>
<span class="w">    </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_values</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_gradients</span><span class="w"> </span><span class="o">|</span>
<span class="w">      </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_quadrature_points</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_JxW_values</span><span class="p">);</span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fe</span><span class="p">.</span><span class="n">dofs_per_cell</span><span class="p">;</span>

<span class="w">  </span><span class="k">auto</span><span class="w">                   </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">tria</span><span class="o">-&gt;</span><span class="n">temporal</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">n_global_active_cells</span><span class="p">();</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cell_rhs</span><span class="p">(</span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">);</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">types</span><span class="o">::</span><span class="n">global_dof_index</span><span class="o">&gt;</span><span class="w"> </span><span class="n">local_spacetime_dof_index</span><span class="p">(</span>
<span class="w">    </span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">);</span>

<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n_quad_spacetime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">n_quadrature_points</span><span class="p">;</span>
<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n_quad_space</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">quad</span><span class="p">.</span><span class="n">spatial</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">FEValuesExtractors</span><span class="o">::</span><span class="n">Vector</span><span class="w"> </span><span class="n">velocity</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">FEValuesExtractors</span><span class="o">::</span><span class="n">Scalar</span><span class="w"> </span><span class="n">pressure</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
</pre></div>
</div>
<p>Compared to the assembly of the system matrix we have to also evaluate the
temporal derivative and the limits at the temporal element edges of the
previous Newton iterate.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">old_solution_values</span><span class="p">(</span>
<span class="w">    </span><span class="n">n_quad_spacetime</span><span class="p">,</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">old_solution_dt</span><span class="p">(</span>
<span class="w">    </span><span class="n">n_quad_spacetime</span><span class="p">,</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="n">old_solution_grads</span><span class="p">(</span>
<span class="w">    </span><span class="n">n_quad_spacetime</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">old_solution_plus</span><span class="p">(</span>
<span class="w">    </span><span class="n">n_quad_space</span><span class="p">,</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">old_solution_minus</span><span class="p">(</span>
<span class="w">    </span><span class="n">n_quad_space</span><span class="p">,</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cell_space</span><span class="w"> </span><span class="o">:</span>
<span class="w">       </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">spatial</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">active_cell_iterators</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cell_space</span><span class="o">-&gt;</span><span class="n">is_locally_owned</span><span class="p">())</span><span class="w"> </span><span class="c1">// only rank local contributions</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">reinit_space</span><span class="p">(</span><span class="n">cell_space</span><span class="p">);</span>
<span class="w">          </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">reinit_space</span><span class="p">(</span><span class="n">cell_space</span><span class="p">);</span>

<span class="w">          </span><span class="n">cell_rhs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cell_time</span><span class="w"> </span><span class="o">:</span>
<span class="w">               </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">temporal</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">active_cell_iterators</span><span class="p">())</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">              </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cell_time</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">();</span>
<span class="w">              </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">reinit_time</span><span class="p">(</span><span class="n">cell_time</span><span class="p">);</span>
<span class="w">              </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">reinit_time</span><span class="p">(</span><span class="n">cell_time</span><span class="p">);</span>
<span class="w">              </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">get_local_dof_indices</span><span class="p">(</span>
<span class="w">                </span><span class="n">local_spacetime_dof_index</span><span class="p">);</span>

<span class="w">              </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">get_function_values</span><span class="p">(</span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="p">,</span>
<span class="w">                                                      </span><span class="n">old_solution_values</span><span class="p">);</span>

<span class="w">              </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">get_function_dt</span><span class="p">(</span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="p">,</span>
<span class="w">                                                  </span><span class="n">old_solution_dt</span><span class="p">);</span>

<span class="w">              </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">get_function_space_gradients</span><span class="p">(</span>
<span class="w">                </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="p">,</span><span class="w"> </span><span class="n">old_solution_grads</span><span class="p">);</span>

<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_quad_spacetime</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">q</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">v</span><span class="p">;</span>
<span class="w">                  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dt_v</span><span class="p">;</span>
<span class="w">                  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">grad_v</span><span class="p">;</span>

<span class="w">                  </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_solution_values</span><span class="p">[</span><span class="n">q</span><span class="p">](</span><span class="mi">2</span><span class="p">);</span>
<span class="w">                  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="o">++</span><span class="p">)</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                      </span><span class="n">v</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">old_solution_values</span><span class="p">[</span><span class="n">q</span><span class="p">](</span><span class="n">c</span><span class="p">);</span>
<span class="w">                      </span><span class="n">dt_v</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_solution_dt</span><span class="p">[</span><span class="n">q</span><span class="p">](</span><span class="n">c</span><span class="p">);</span>
<span class="w">                      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="o">++</span><span class="p">)</span>
<span class="w">                        </span><span class="p">{</span>
<span class="w">                          </span><span class="n">grad_v</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">d</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_solution_grads</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">d</span><span class="p">];</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                  </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">div_v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">trace</span><span class="p">(</span><span class="n">grad_v</span><span class="p">);</span>

<span class="w">                  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">                    </span><span class="p">{</span>
</pre></div>
</div>
<p>(dt u, v)</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">                      </span><span class="n">cell_rhs</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">)</span><span class="w"> </span><span class="o">-=</span>
<span class="w">                        </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">vector_value</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                        </span><span class="n">dt_v</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
</pre></div>
</div>
<p>convection</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">                      </span><span class="n">cell_rhs</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">)</span><span class="w"> </span><span class="o">-=</span>
<span class="w">                        </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">vector_value</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                        </span><span class="n">grad_v</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
</pre></div>
</div>
<p>(grad u, grad v)</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">                      </span><span class="n">cell_rhs</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">)</span><span class="w"> </span><span class="o">-=</span>
<span class="w">                        </span><span class="n">nu_f</span><span class="w"> </span><span class="o">*</span>
<span class="w">                        </span><span class="n">dealii</span><span class="o">::</span><span class="n">scalar_product</span><span class="p">(</span>
<span class="w">                          </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">vector_space_grad</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">),</span>
<span class="w">                          </span><span class="n">grad_v</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                        </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
</pre></div>
</div>
<p>(pressure gradient)</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">                      </span><span class="n">cell_rhs</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">)</span><span class="w"> </span><span class="o">+=</span>
<span class="w">                        </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">vector_divergence</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                        </span><span class="n">p</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
</pre></div>
</div>
<p>(div free constraint)</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">                      </span><span class="n">cell_rhs</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">)</span><span class="w"> </span><span class="o">-=</span>
<span class="w">                        </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">scalar_value</span><span class="p">(</span><span class="n">pressure</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                        </span><span class="n">div_v</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

<span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="c1">// dofs i</span>

<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="c1">// quad</span>

<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                  </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">spatial</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_function_values</span><span class="p">(</span>
<span class="w">                    </span><span class="n">slab_initial_value</span><span class="p">,</span><span class="w"> </span><span class="n">old_solution_minus</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">              </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">get_function_values_plus</span><span class="p">(</span>
<span class="w">                </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="p">,</span><span class="w"> </span><span class="n">old_solution_plus</span><span class="p">);</span>

<span class="w">              </span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">v_plus</span><span class="p">;</span>
<span class="w">              </span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">v_minus</span><span class="p">;</span>

<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_quad_space</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">q</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">c</span><span class="p">)</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                      </span><span class="n">v_plus</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">old_solution_plus</span><span class="p">[</span><span class="n">q</span><span class="p">](</span><span class="n">c</span><span class="p">);</span>
<span class="w">                      </span><span class="n">v_minus</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_solution_minus</span><span class="p">[</span><span class="n">q</span><span class="p">](</span><span class="n">c</span><span class="p">);</span>
<span class="w">                    </span><span class="p">}</span>

<span class="w">                  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">                    </span><span class="p">{</span>
</pre></div>
</div>
<p><span class="math notranslate nohighlight">\((u^+, v^+)\)</span></p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">                      </span><span class="n">cell_rhs</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">)</span><span class="w"> </span><span class="o">-=</span>
<span class="w">                        </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">vector_value_plus</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span>
<span class="w">                                                                   </span><span class="n">i</span><span class="p">,</span>
<span class="w">                                                                   </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                        </span><span class="n">v_plus</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
</pre></div>
</div>
<p><span class="math notranslate nohighlight">\(-(u^-, v^+)\)</span></p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">                      </span><span class="n">cell_rhs</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">)</span><span class="w"> </span><span class="o">+=</span>
<span class="w">                        </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">vector_value_plus</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span>
<span class="w">                                                                   </span><span class="n">i</span><span class="p">,</span>
<span class="w">                                                                   </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                        </span><span class="n">v_minus</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

<span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="c1">// dofs i</span>

<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="c1">// quad_space</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                  </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">get_function_values_minus</span><span class="p">(</span>
<span class="w">                    </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="p">,</span><span class="w"> </span><span class="n">old_solution_minus</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="c1">// cell time</span>
<span class="w">          </span><span class="n">slab_zero_constraints</span><span class="o">-&gt;</span><span class="n">distribute_local_to_global</span><span class="p">(</span>
<span class="w">            </span><span class="n">cell_rhs</span><span class="p">,</span><span class="w"> </span><span class="n">local_spacetime_dof_index</span><span class="p">,</span><span class="w"> </span><span class="n">slab_system_rhs</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="c1">// cell space</span>
</pre></div>
</div>
<p>We need to communicate local contributions to other processors after
assembly</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">slab_system_rhs</span><span class="p">.</span><span class="n">compress</span><span class="p">(</span><span class="n">dealii</span><span class="o">::</span><span class="n">VectorOperation</span><span class="o">::</span><span class="n">add</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="step4-solve-newton-problem-on-slab">
<h4><a class="toc-backref" href="#id19" role="doc-backlink">Step4::solve_Newton_problem_on_slab</a><a class="headerlink" href="#step4-solve-newton-problem-on-slab" title="Link to this heading"></a></h4>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="nf">Step4::solve_Newton_problem_on_slab</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">pout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Starting Newton solve&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</pre></div>
</div>
<p>We use a direct solver as the inner solver for each Newton iterate.
Again, if you installed Trilinos with other third party solvers you can
change them, e.g. to MUMPS or SuperLU_dist.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">SolverControl</span><span class="w"> </span><span class="nf">sc</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0e-14</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">SolverDirect</span><span class="o">::</span><span class="n">AdditionalData</span><span class="w"> </span><span class="n">ad</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span>
<span class="w">                                                            </span><span class="s">&quot;Amesos_Klu&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">solver</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">SolverDirect</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span><span class="w"> </span><span class="n">ad</span><span class="p">);</span>
</pre></div>
</div>
<p>Newton parameters</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kt">double</span><span class="w">       </span><span class="n">newton_lower_bound</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0e-10</span><span class="p">;</span>
<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">max_newton_steps</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">max_line_search_steps</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w">       </span><span class="n">newton_rebuild_parameter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w">       </span><span class="n">newton_damping</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="mf">0.6</span><span class="p">;</span>

<span class="w">  </span><span class="n">assemble_residual_on_slab</span><span class="p">();</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">newton_residual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slab_system_rhs</span><span class="p">.</span><span class="n">linfty_norm</span><span class="p">();</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">old_newton_residual</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">new_newton_residual</span><span class="p">;</span>

<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">newton_step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">line_search_step</span><span class="p">;</span>

<span class="w">  </span><span class="n">pout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;0</span><span class="se">\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">newton_residual</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
</pre></div>
</div>
<p>We iterate either until the newton residual is small enough,
or until we have reached the maxmimum number of Newton steps.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">newton_residual</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">newton_lower_bound</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">         </span><span class="n">newton_step</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">max_newton_steps</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">old_newton_residual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newton_residual</span><span class="p">;</span>
<span class="w">      </span><span class="n">assemble_residual_on_slab</span><span class="p">();</span>
<span class="w">      </span><span class="n">newton_residual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slab_system_rhs</span><span class="p">.</span><span class="n">linfty_norm</span><span class="p">();</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newton_residual</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">newton_lower_bound</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="n">pout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;res</span><span class="se">\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">newton_residual</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
</pre></div>
</div>
<p>If we do not have enough reduction from the previous step,
we assemble a new system matrix with the most current iterate.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newton_residual</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">old_newton_residual</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">newton_rebuild_parameter</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="n">solver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="w">          </span><span class="n">solver</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">SolverDirect</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span><span class="w"> </span><span class="n">ad</span><span class="p">);</span>
<span class="w">          </span><span class="n">assemble_system_on_slab</span><span class="p">();</span>
</pre></div>
</div>
<p>Since we are using a direct solver we only have to do the costly
factorization once after assembling a new matrix.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">          </span><span class="n">solver</span><span class="o">-&gt;</span><span class="n">initialize</span><span class="p">(</span><span class="n">slab_system_matrix</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
</pre></div>
</div>
<p>Having an existing factorization we only have to do the actual solve,
i.e. two triangular matrix solves.
Note that we solve for an update, i.e. <span class="math notranslate nohighlight">\(\delta U\)</span> instead of
<span class="math notranslate nohighlight">\(U\)</span> directly.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">      </span><span class="n">solver</span><span class="o">-&gt;</span><span class="n">solve</span><span class="p">(</span><span class="n">slab_newton_update</span><span class="p">,</span><span class="w"> </span><span class="n">slab_system_rhs</span><span class="p">);</span>
</pre></div>
</div>
<p>We have to make sure the boundary values are correct.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">      </span><span class="n">slab_zero_constraints</span><span class="o">-&gt;</span><span class="n">distribute</span><span class="p">(</span><span class="n">slab_newton_update</span><span class="p">);</span>
</pre></div>
</div>
<p>Finally we update the ghost values in the temporary vector.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">      </span><span class="n">slab_owned_tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="p">;</span>
</pre></div>
</div>
<p>Now, we update our solution with a possibly damped upgrade,
i.e. <span class="math notranslate nohighlight">\(U^\text{new}=U^\text{old}+\alpha\delta U\)</span>.
We start by trying a full step (<span class="math notranslate nohighlight">\(\alpha=1\)</span>) and check if that
leads to a reduction in the residual. If that is not the case,
we dampen the update by multiplying the step length <span class="math notranslate nohighlight">\(\alpha\)</span> with
<code class="docutils literal notranslate"><span class="pre">newton_damping</span></code>. We continue dampening until we get a reduction or
until we have done <code class="docutils literal notranslate"><span class="pre">max_line_search_steps</span></code> dampening steps.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">line_search_step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">line_search_step</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">max_line_search_steps</span><span class="p">;</span>
<span class="w">           </span><span class="n">line_search_step</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="n">slab_owned_tmp</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">slab_newton_update</span><span class="p">;</span>
<span class="w">          </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slab_owned_tmp</span><span class="p">;</span>
<span class="w">          </span><span class="n">assemble_residual_on_slab</span><span class="p">();</span>

<span class="w">          </span><span class="n">new_newton_residual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slab_system_rhs</span><span class="p">.</span><span class="n">linfty_norm</span><span class="p">();</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">new_newton_residual</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">newton_residual</span><span class="p">)</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">          </span><span class="k">else</span>
<span class="w">            </span><span class="n">slab_owned_tmp</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">slab_newton_update</span><span class="p">;</span>

<span class="w">          </span><span class="n">slab_newton_update</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">newton_damping</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
</pre></div>
</div>
<p>In the following we output information on the current Newton step
to console, including the current residual, reduction and whether or
not the matrix had to be rebuilt</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">      </span><span class="n">pout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">setprecision</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">newton_step</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">scientific</span>
<span class="w">           </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">newton_residual</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">scientific</span>
<span class="w">           </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">newton_residual</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">old_newton_residual</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">;</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newton_residual</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">old_newton_residual</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">newton_rebuild_parameter</span><span class="p">)</span>
<span class="w">        </span><span class="n">pout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;r</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">        </span><span class="n">pout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; </span><span class="se">\t</span><span class="s">&quot;</span><span class="p">;</span>

<span class="w">      </span><span class="n">pout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">line_search_step</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">scientific</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

<span class="w">      </span><span class="n">newton_step</span><span class="o">++</span><span class="p">;</span><span class="w"> </span><span class="c1">// Update working index</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="step4-calculate-functional-values-on-slab">
<h4><a class="toc-backref" href="#id20" role="doc-backlink">Step4::calculate_functional_values_on_slab</a><a class="headerlink" href="#step4-calculate-functional-values-on-slab" title="Link to this heading"></a></h4>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="nf">Step4::calculate_functional_values_on_slab</span><span class="p">()</span>
<span class="p">{</span>
</pre></div>
</div>
<p>We want to plot the curves of the functional values,
so we need to know the time points.
The following constructs a dummy quadrature rule that does
not have valid weights and is only used to get the support points of the
temporal finite element.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Quadrature</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">quad_time</span><span class="p">(</span>
<span class="w">    </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">temporal</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_fe</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">get_unit_support_points</span><span class="p">());</span>
</pre></div>
</div>
<p>Similarly, our temporal FEValues object is only used to query the support
points.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">FEValues</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fev</span><span class="p">(</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">temporal</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_fe</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<span class="w">                          </span><span class="n">quad_time</span><span class="p">,</span>
<span class="w">                          </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_quadrature_points</span><span class="p">);</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">types</span><span class="o">::</span><span class="n">global_dof_index</span><span class="o">&gt;</span><span class="w"> </span><span class="n">local_indices</span><span class="p">(</span>
<span class="w">    </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">dofs_per_cell_time</span><span class="p">());</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">n_dofs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">n_dofs_time</span><span class="p">();</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">Vector</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="p">;</span>
</pre></div>
</div>
<p>allocate storage only once</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kt">double</span><span class="w">       </span><span class="n">time</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span><span class="p">;</span>
<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">time_dof</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w">       </span><span class="n">pfront</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w">       </span><span class="n">pback</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w">       </span><span class="n">pdiff</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span><span class="p">;</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">drag_lift_tensor</span><span class="p">;</span>
</pre></div>
</div>
<p>Points for pressure evaluation</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Point</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">front</span><span class="p">(</span><span class="mf">0.15</span><span class="p">,</span><span class="w"> </span><span class="mf">0.2</span><span class="p">);</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Point</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">back</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span><span class="w"> </span><span class="mf">0.2</span><span class="p">);</span>
</pre></div>
</div>
<p>The vector to extract the solution at a given temporal DoF to</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">Vector</span><span class="w"> </span><span class="n">local_solution</span><span class="p">;</span>
<span class="w">  </span><span class="n">local_solution</span><span class="p">.</span><span class="n">reinit</span><span class="p">(</span><span class="n">space_locally_owned_dofs</span><span class="p">,</span>
<span class="w">                        </span><span class="n">space_locally_relevant_dofs</span><span class="p">,</span>
<span class="w">                        </span><span class="n">mpi_comm</span><span class="p">);</span>
</pre></div>
</div>
<p>In contrast to the assembly functions we start with the temporal
element loop here as we want to write out the functional values
in sequence.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cell_time</span><span class="w"> </span><span class="o">:</span>
<span class="w">       </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">temporal</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">active_cell_iterators</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">fev</span><span class="p">.</span><span class="n">reinit</span><span class="p">(</span><span class="n">cell_time</span><span class="p">);</span>
<span class="w">      </span><span class="n">cell_time</span><span class="o">-&gt;</span><span class="n">get_dof_indices</span><span class="p">(</span><span class="n">local_indices</span><span class="p">);</span>

<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">quad_time</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">q</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="n">time</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">fev</span><span class="p">.</span><span class="n">quadrature_point</span><span class="p">(</span><span class="n">q</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">          </span><span class="n">time_dof</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_indices</span><span class="p">[</span><span class="n">q</span><span class="p">];</span>

<span class="w">          </span><span class="n">idealii</span><span class="o">::</span><span class="n">slab</span><span class="o">::</span><span class="n">VectorTools</span><span class="o">::</span><span class="n">extract_subvector_at_time_dof</span><span class="p">(</span>
<span class="w">            </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="p">,</span><span class="w"> </span><span class="n">local_solution</span><span class="p">,</span><span class="w"> </span><span class="n">time_dof</span><span class="p">);</span>
</pre></div>
</div>
<p>The actual functional value calculations are put into seperate
functions to make the whole problem easier to extend.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">          </span><span class="n">pfront</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculate_pressure_at_point</span><span class="p">(</span><span class="n">front</span><span class="p">,</span><span class="w"> </span><span class="n">local_solution</span><span class="p">);</span>
<span class="w">          </span><span class="n">pback</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">calculate_pressure_at_point</span><span class="p">(</span><span class="n">back</span><span class="p">,</span><span class="w"> </span><span class="n">local_solution</span><span class="p">);</span>
<span class="w">          </span><span class="n">pdiff</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">pfront</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pback</span><span class="p">;</span>

<span class="w">          </span><span class="n">calculate_drag_lift_tensor</span><span class="p">(</span><span class="n">local_solution</span><span class="p">,</span><span class="w"> </span><span class="n">drag_lift_tensor</span><span class="p">);</span>
</pre></div>
</div>
<p>We want to write a comma seperated values (CSV) file,
so we write out the values for this DoF in a single line.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">          </span><span class="n">functional_log</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">pfront</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">pback</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span>
<span class="w">                         </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">pdiff</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">drag_lift_tensor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span>
<span class="w">                         </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">drag_lift_tensor</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="step4-calculate-pressure-at-point">
<h4><a class="toc-backref" href="#id21" role="doc-backlink">Step4::calculate_pressure_at_point</a><a class="headerlink" href="#step4-calculate-pressure-at-point" title="Link to this heading"></a></h4>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">double</span>
<span class="nf">Step4::calculate_pressure_at_point</span><span class="p">(</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Point</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w">                       </span><span class="n">x</span><span class="p">,</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">Vector</span><span class="w"> </span><span class="o">&amp;</span><span class="n">u</span><span class="p">)</span>
<span class="p">{</span>
</pre></div>
</div>
<p>Storage for the local solution at the given point.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x_h</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
</pre></div>
</div>
<p>The evaluation point will only live on a single rank, so we catch the
<code class="docutils literal notranslate"><span class="pre">ExcPointNotAvailableHere</span></code> exception on all others</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">try</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">dealii</span><span class="o">::</span><span class="n">VectorTools</span><span class="o">::</span><span class="n">point_value</span><span class="p">(</span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">spatial</span><span class="p">(),</span><span class="w"> </span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">x_h</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="k">typename</span><span class="w"> </span><span class="nc">dealii</span><span class="o">::</span><span class="n">VectorTools</span><span class="o">::</span><span class="n">ExcPointNotAvailableHere</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="w">    </span><span class="p">{}</span>
</pre></div>
</div>
<p>We need to figure out which rank has the nonzero value</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">minmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Utilities</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">min_max_avg</span><span class="p">(</span><span class="n">x_h</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">mpi_comm</span><span class="p">);</span>
</pre></div>
</div>
<p>Check if the actual value is negative, i.e. it’s absolute value is
larger than the maximum (which then is 0)</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">(</span><span class="n">minmax</span><span class="p">.</span><span class="n">min</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">minmax</span><span class="p">.</span><span class="n">max</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">minmax</span><span class="p">.</span><span class="n">min</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">minmax</span><span class="p">.</span><span class="n">max</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="step4-calculate-drag-lift-tensor">
<h4><a class="toc-backref" href="#id22" role="doc-backlink">Step4::calculate_drag_lift_tensor</a><a class="headerlink" href="#step4-calculate-drag-lift-tensor" title="Link to this heading"></a></h4>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="nf">Step4::calculate_drag_lift_tensor</span><span class="p">(</span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">Vector</span><span class="w"> </span><span class="o">&amp;</span><span class="n">u</span><span class="p">,</span>
<span class="w">                                  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">drag_lift_value</span><span class="p">)</span>
<span class="p">{</span>
</pre></div>
</div>
<p>We want to calculate drag and lift on the obstacle boundary,
so we need a face quadrature rule and matching <code class="docutils literal notranslate"><span class="pre">FEFaceValues</span></code></p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">QGauss</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">face_quad</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">FEFaceValues</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fe_face_values</span><span class="p">(</span><span class="o">*</span><span class="n">fe</span><span class="p">.</span><span class="n">spatial</span><span class="p">(),</span>
<span class="w">                                         </span><span class="n">face_quad</span><span class="p">,</span>
<span class="w">                                         </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_values</span><span class="w"> </span><span class="o">|</span>
<span class="w">                                           </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_gradients</span><span class="w"> </span><span class="o">|</span>
<span class="w">                                           </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_normal_vectors</span><span class="w"> </span><span class="o">|</span>
<span class="w">                                           </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_JxW_values</span><span class="w"> </span><span class="o">|</span>
<span class="w">                                           </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_quadrature_points</span><span class="p">);</span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">dofs_per_cell</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">dofs_per_cell_space</span><span class="p">();</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n_face_q_points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">face_quad</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">local_dof_indices</span><span class="p">(</span><span class="n">dofs_per_cell</span><span class="p">);</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">face_solution_values</span><span class="p">(</span>
<span class="w">    </span><span class="n">n_face_q_points</span><span class="p">,</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="n">face_solution_grads</span><span class="p">(</span>
<span class="w">    </span><span class="n">n_face_q_points</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
</pre></div>
</div>
<p>Allocate storage for <span class="math notranslate nohighlight">\(p*I\)</span>, <span class="math notranslate nohighlight">\(\nabla v\)</span> and the stress tensor
<span class="math notranslate nohighlight">\(-p*I+\nu*\nabla v\)</span> needed in the calculation</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pI</span><span class="p">;</span>
<span class="w">  </span><span class="n">pI</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">grad_v</span><span class="p">;</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stress</span>

<span class="w">    </span><span class="n">drag_lift_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span><span class="p">;</span>
</pre></div>
</div>
<p>We loop over spatial elements only as we call this function from within a
temporal loop. We only consider elements that are owned by the current rank
and also at a boundary.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cell</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">spatial</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">active_cell_iterators</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">is_locally_owned</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">at_boundary</span><span class="p">())</span>
<span class="w">        </span><span class="p">{</span>
</pre></div>
</div>
<p>On each spatial element we loop over the faces and only consider
those that are at the obstacle boundary (id 80)</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">face</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">               </span><span class="n">face</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">GeometryInfo</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;::</span><span class="n">faces_per_cell</span><span class="p">;</span>
<span class="w">               </span><span class="o">++</span><span class="n">face</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">face</span><span class="p">(</span><span class="n">face</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">at_boundary</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                </span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">face</span><span class="p">(</span><span class="n">face</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">boundary_id</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">80</span><span class="p">)</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="n">fe_face_values</span><span class="p">.</span><span class="n">reinit</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="w"> </span><span class="n">face</span><span class="p">);</span>
<span class="w">                </span><span class="n">fe_face_values</span><span class="p">.</span><span class="n">get_function_values</span><span class="p">(</span><span class="n">slab_initial_value</span><span class="p">,</span>
<span class="w">                                                   </span><span class="n">face_solution_values</span><span class="p">);</span>
<span class="w">                </span><span class="n">fe_face_values</span><span class="p">.</span><span class="n">get_function_gradients</span><span class="p">(</span><span class="n">slab_initial_value</span><span class="p">,</span>
<span class="w">                                                      </span><span class="n">face_solution_grads</span><span class="p">);</span>
</pre></div>
</div>
<p>Loop over quadrature points on the current face</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_face_q_points</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">q</span><span class="p">)</span>
<span class="w">                  </span><span class="p">{</span>
</pre></div>
</div>
<p>Update the values in <span class="math notranslate nohighlight">\(p*I\)</span> and <span class="math notranslate nohighlight">\(\nabla v\)</span></p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">l</span><span class="p">)</span>
<span class="w">                      </span><span class="p">{</span>
<span class="w">                        </span><span class="n">pI</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">l</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">face_solution_values</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
<span class="w">                        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">m</span><span class="p">)</span>
<span class="w">                          </span><span class="p">{</span>
<span class="w">                            </span><span class="n">grad_v</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">m</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">face_solution_grads</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="n">l</span><span class="p">][</span><span class="n">m</span><span class="p">];</span>
<span class="w">                          </span><span class="p">}</span>
<span class="w">                      </span><span class="p">}</span>

<span class="w">                    </span><span class="n">stress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">pI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nu_f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">grad_v</span><span class="p">;</span>
</pre></div>
</div>
<p>Add the local contributions to the drag lift tensor</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">                    </span><span class="n">drag_lift_value</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">stress</span><span class="w"> </span><span class="o">*</span>
<span class="w">                                       </span><span class="n">fe_face_values</span><span class="p">.</span><span class="n">normal_vector</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                                       </span><span class="n">fe_face_values</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
</pre></div>
</div>
<p>For now we only have rank local contributions to the drag lift tensor,
so we need to sum these up.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Utilities</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">sum</span><span class="p">(</span><span class="n">drag_lift_value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">mpi_comm</span><span class="p">);</span>
<span class="w">  </span><span class="n">drag_lift_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span>
<span class="w">  </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Utilities</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">sum</span><span class="p">(</span><span class="n">drag_lift_value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">mpi_comm</span><span class="p">);</span>
<span class="w">  </span><span class="n">drag_lift_value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span>
</pre></div>
</div>
<p>Finally, we have to scale the calculated value.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">drag_lift_value</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mf">20.</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
<section id="step4-output-results-on-slab">
<h4><a class="toc-backref" href="#id23" role="doc-backlink">Step4::output_results_on_slab</a><a class="headerlink" href="#step4-output-results-on-slab" title="Link to this heading"></a></h4>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">void</span>
<span class="nf">Step4::output_results_on_slab</span><span class="p">()</span><span class="w"> </span><span class="c1">// Nothing new compared to step-2</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">auto</span><span class="w">                     </span><span class="n">n_dofs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">n_dofs_time</span><span class="p">();</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">field_names</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">DataComponentInterpretation</span><span class="o">::</span><span class="n">DataComponentInterpretation</span><span class="o">&gt;</span>
<span class="w">    </span><span class="n">dci</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">field_names</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="s">&quot;velocity&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="n">dci</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span>
<span class="w">        </span><span class="n">dealii</span><span class="o">::</span><span class="n">DataComponentInterpretation</span><span class="o">::</span><span class="n">component_is_part_of_vector</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="n">field_names</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="s">&quot;pressure&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">dci</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">dealii</span><span class="o">::</span><span class="n">DataComponentInterpretation</span><span class="o">::</span><span class="n">component_is_scalar</span><span class="p">);</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">Vector</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_dofs</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">dealii</span><span class="o">::</span><span class="n">DataOut</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">data_out</span><span class="p">;</span>
<span class="w">      </span><span class="n">data_out</span><span class="p">.</span><span class="n">attach_dof_handler</span><span class="p">(</span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">spatial</span><span class="p">());</span>
<span class="w">      </span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">Vector</span><span class="w"> </span><span class="n">local_solution</span><span class="p">;</span>
<span class="w">      </span><span class="n">local_solution</span><span class="p">.</span><span class="n">reinit</span><span class="p">(</span><span class="n">space_locally_owned_dofs</span><span class="p">,</span>
<span class="w">                            </span><span class="n">space_locally_relevant_dofs</span><span class="p">,</span>
<span class="w">                            </span><span class="n">mpi_comm</span><span class="p">);</span>

<span class="w">      </span><span class="n">idealii</span><span class="o">::</span><span class="n">slab</span><span class="o">::</span><span class="n">VectorTools</span><span class="o">::</span><span class="n">extract_subvector_at_time_dof</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span>
<span class="w">                                                                </span><span class="n">local_solution</span><span class="p">,</span>
<span class="w">                                                                </span><span class="n">i</span><span class="p">);</span>

<span class="w">      </span><span class="n">data_out</span><span class="p">.</span><span class="n">add_data_vector</span><span class="p">(</span><span class="n">local_solution</span><span class="p">,</span>
<span class="w">                               </span><span class="n">field_names</span><span class="p">,</span>
<span class="w">                               </span><span class="n">dealii</span><span class="o">::</span><span class="n">DataOut</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;::</span><span class="n">type_dof_data</span><span class="p">,</span>
<span class="w">                               </span><span class="n">dci</span><span class="p">);</span>
<span class="w">      </span><span class="n">data_out</span><span class="p">.</span><span class="n">build_patches</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">ostringstream</span><span class="w"> </span><span class="n">filename</span><span class="p">;</span>
<span class="w">      </span><span class="n">filename</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;newton_navierstokes_solution_dG(&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">fe</span><span class="p">.</span><span class="n">temporal</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">degree</span>
<span class="w">               </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;)_t_&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">slab</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n_dofs</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;.vtu&quot;</span><span class="p">;</span>
</pre></div>
</div>
<p>instead of a vtk we use the parallel write function</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">      </span><span class="n">data_out</span><span class="p">.</span><span class="n">write_vtu_in_parallel</span><span class="p">(</span><span class="n">filename</span><span class="p">.</span><span class="n">str</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">mpi_comm</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="the-main-function">
<h3><a class="toc-backref" href="#id24" role="doc-backlink">The main function</a><a class="headerlink" href="#the-main-function" title="Link to this heading"></a></h3>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="kt">int</span>
<span class="nf">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
</pre></div>
</div>
<p>With MPI we need to begin with an InitFinalize call.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Utilities</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">MPI_InitFinalize</span><span class="w"> </span><span class="nf">mpi</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
</pre></div>
</div>
<p>As in step-3 we want to pass command line arguments for a
parameter study, but we only want to be able to suppress VTU output
and vary the temporal finite element order.</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">Teuchos</span><span class="o">::</span><span class="n">CommandLineProcessor</span><span class="w"> </span><span class="n">clp</span><span class="p">;</span>
<span class="w">  </span><span class="n">clp</span><span class="p">.</span><span class="n">setDocString</span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;This example program demonstrates solving the Navier-Stokes &quot;</span>
<span class="w">    </span><span class="s">&quot;equation with Trilinos + MPI&quot;</span><span class="p">);</span>


<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">write_vtu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">  </span><span class="n">clp</span><span class="p">.</span><span class="n">setOption</span><span class="p">(</span><span class="s">&quot;write-vtu&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s">&quot;no-vtu&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="o">&amp;</span><span class="n">write_vtu</span><span class="p">,</span>
<span class="w">                </span><span class="s">&quot;Write results into vtu files?&quot;</span><span class="p">);</span>
</pre></div>
</div>
<p>temporal finite element order</p>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="n">clp</span><span class="p">.</span><span class="n">setOption</span><span class="p">(</span><span class="s">&quot;r&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;temporal FE degree&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">clp</span><span class="p">.</span><span class="n">throwExceptions</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>

<span class="w">  </span><span class="n">Teuchos</span><span class="o">::</span><span class="n">CommandLineProcessor</span><span class="o">::</span><span class="n">EParseCommandLineReturn</span><span class="w"> </span><span class="n">parse_return</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">clp</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parse_return</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Teuchos</span><span class="o">::</span><span class="n">CommandLineProcessor</span><span class="o">::</span><span class="n">PARSE_HELP_PRINTED</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// don&#39;t fail if the program was called with ``--help``.</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parse_return</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">Teuchos</span><span class="o">::</span><span class="n">CommandLineProcessor</span><span class="o">::</span><span class="n">PARSE_SUCCESSFUL</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// Error!</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">  </span><span class="n">Step4</span><span class="w"> </span><span class="n">problem</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">write_vtu</span><span class="p">);</span>
<span class="w">  </span><span class="n">problem</span><span class="p">.</span><span class="n">run</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>
<section id="results">
<h2><a class="toc-backref" href="#id25" role="doc-backlink">Results</a><a class="headerlink" href="#results" title="Link to this heading"></a></h2>
<p>As before we start with the animations of the resulting fields,
i.e. velocity magnitude and pressure, in the VTU files.</p>
<video autoplay="True" controls="True" height="800" loop="True" preload="auto"><source src="../_images/step-4-velocity.ogv" type="video/ogg"></video><video autoplay="True" controls="True" height="800" loop="True" preload="auto"><source src="../_images/step-4-pressure.ogv" type="video/ogg"></video><section id="comparison-to-benchmark-results">
<h3><a class="toc-backref" href="#id26" role="doc-backlink">Comparison to benchmark results</a><a class="headerlink" href="#comparison-to-benchmark-results" title="Link to this heading"></a></h3>
<p>Finally, we want to compare our results to results from the
finite element software
<a class="reference external" href="https://wwwold.mathematik.tu-dortmund.de/~featflow/en">FEATFLOW</a>
which are published on their
<a class="reference external" href="https://wwwold.mathematik.tu-dortmund.de/~featflow/en/benchmarks/cfdbenchmarking/flow/dfg_benchmark3_re100.html">benchmark website</a>.</p>
<p>The <em>ideal.II</em> results have been obtained by runnning the R files in the example
folder.</p>
<p>We can see that the  drag coefficient mostly depends on the
spatial discretization as our results overlay each other
until <span class="math notranslate nohighlight">\(t\approx 4.2\)</span>.
We can also see that <span class="math notranslate nohighlight">\(dG(0)\)</span> produces a smoother curve
due to numerical dampening.</p>
<img alt="../_images/NSE_results_idealii_vs_FEATFLOW_drag.svg" src="../_images/NSE_results_idealii_vs_FEATFLOW_drag.svg" />
<p>For the lift we can see the numerical dampening even more clearly
as the <span class="math notranslate nohighlight">\(dG(0)\)</span> discretization does not produce
the correct oscillations.
For the higher order discretizations we see that the
oscillation frequency is close to the results of FEATFLOW
with refinement level 2, which has a similar number of
spatial DoFs.
We also see that the peaks are not matching, which
might in part be because there is no temporal DoF close enough
to the peak point.</p>
<img alt="../_images/NSE_results_idealii_vs_FEATFLOW_lift.svg" src="../_images/NSE_results_idealii_vs_FEATFLOW_lift.svg" />
<p>For the pressure we see a similar picture compared to the drag,
but now our results are almost completely overlaying the
FEATFLOW level 2 results.
.. image:: ../_static/examples/NSE_results_idealii_vs_FEATFLOW_pressure.svg</p>
</section>
</section>
<section id="the-plain-program">
<h2><a class="toc-backref" href="#id27" role="doc-backlink">The plain program</a><a class="headerlink" href="#the-plain-program" title="Link to this heading"></a></h2>
<div class="highlight-c++ notranslate"><div class="highlight"><pre><span></span><span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ideal.II/base/quadrature_lib.hh&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ideal.II/base/time_iterator.hh&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ideal.II/distributed/fixed_tria.hh&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ideal.II/dofs/slab_dof_tools.hh&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ideal.II/dofs/spacetime_dof_handler.hh&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ideal.II/fe/fe_dg.hh&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ideal.II/fe/spacetime_fe_values.hh&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ideal.II/lac/spacetime_trilinos_vector.hh&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;ideal.II/numerics/vector_tools.hh&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/base/conditional_ostream.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/base/function.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/distributed/tria.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/fe/fe_q.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/fe/fe_system.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/grid/grid_in.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/grid/grid_tools.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/grid/manifold_lib.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/lac/dynamic_sparsity_pattern.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/lac/full_matrix.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/lac/sparse_direct.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/lac/sparsity_tools.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/lac/trilinos_solver.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/lac/trilinos_sparse_matrix.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/lac/trilinos_vector.h&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/lac/vector.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;deal.II/numerics/data_out.h&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;Teuchos_CommandLineProcessor.hpp&gt;</span>

<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;fstream&gt;</span>
<span class="cp">#include</span><span class="w"> </span><span class="cpf">&lt;vector&gt;</span>

<span class="k">class</span><span class="w"> </span><span class="nc">PoisseuilleInflow</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="k">public</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Function</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="n">PoisseuilleInflow</span><span class="p">(</span><span class="kt">double</span><span class="w"> </span><span class="n">max_inflow_velocity</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">1.5</span><span class="p">,</span>
<span class="w">                    </span><span class="kt">double</span><span class="w"> </span><span class="n">channel_height</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="mf">0.41</span><span class="p">)</span>
<span class="w">    </span><span class="o">:</span><span class="w"> </span><span class="n">Function</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">max_inflow_velocity</span><span class="p">(</span><span class="n">max_inflow_velocity</span><span class="p">)</span>
<span class="w">    </span><span class="p">,</span><span class="w"> </span><span class="n">H</span><span class="p">(</span><span class="n">channel_height</span><span class="p">)</span>
<span class="w">  </span><span class="p">{}</span>

<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="kt">double</span>
<span class="w">  </span><span class="n">value</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Point</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">component</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="w">  </span><span class="k">virtual</span><span class="w"> </span><span class="kt">void</span>
<span class="w">  </span><span class="nf">vector_value</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Point</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">value</span><span class="p">)</span><span class="w"> </span><span class="k">const</span><span class="p">;</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">max_inflow_velocity</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">H</span><span class="p">;</span>
<span class="p">};</span>

<span class="kt">double</span>
<span class="nf">PoisseuilleInflow::value</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Point</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span>
<span class="w">                         </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">      </span><span class="n">component</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">Assert</span><span class="p">(</span><span class="n">component</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">n_components</span><span class="p">,</span>
<span class="w">         </span><span class="n">dealii</span><span class="o">::</span><span class="n">ExcIndexRange</span><span class="p">(</span><span class="n">component</span><span class="p">,</span>
<span class="w">                               </span><span class="mi">0</span><span class="p">,</span>
<span class="w">                               </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">n_components</span><span class="p">))</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">component</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="kt">double</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">p</span><span class="p">(</span><span class="mi">1</span><span class="p">);</span>
<span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">p</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mf">0.41</span><span class="p">)</span>
<span class="w">      </span><span class="p">{</span>
<span class="w">        </span><span class="kt">double</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">get_time</span><span class="p">();</span>
<span class="w">        </span><span class="k">return</span><span class="w"> </span><span class="mi">4</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">max_inflow_velocity</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">y</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="n">H</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">y</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">               </span><span class="n">std</span><span class="o">::</span><span class="n">sin</span><span class="p">(</span><span class="n">M_PI</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">t</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="mf">0.125</span><span class="p">)</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="p">(</span><span class="n">H</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">H</span><span class="p">);</span>
<span class="w">      </span><span class="p">}</span>
<span class="w">  </span><span class="p">}</span>
<span class="w">  </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="nf">PoisseuilleInflow::vector_value</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Point</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">p</span><span class="p">,</span>
<span class="w">                                </span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">values</span><span class="p">)</span><span class="w"> </span><span class="k">const</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="k">this</span><span class="o">-&gt;</span><span class="n">n_components</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">values</span><span class="p">(</span><span class="n">c</span><span class="p">)</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">value</span><span class="p">(</span><span class="n">p</span><span class="p">,</span><span class="w"> </span><span class="n">c</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>


<span class="k">class</span><span class="w"> </span><span class="nc">Step4</span>
<span class="p">{</span>
<span class="k">public</span><span class="o">:</span>
<span class="w">  </span><span class="n">Step4</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">temporal_degree</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">write_vtu</span><span class="p">);</span>
<span class="w">  </span><span class="kt">void</span>
<span class="w">  </span><span class="nf">run</span><span class="p">();</span>

<span class="k">private</span><span class="o">:</span>
<span class="w">  </span><span class="kt">void</span>
<span class="w">  </span><span class="n">make_grid</span><span class="p">();</span>
<span class="w">  </span><span class="kt">void</span>
<span class="w">  </span><span class="nf">time_marching</span><span class="p">();</span>
<span class="w">  </span><span class="kt">void</span>
<span class="w">  </span><span class="nf">setup_system_on_slab</span><span class="p">();</span>
<span class="w">  </span><span class="kt">void</span>
<span class="w">  </span><span class="nf">assemble_residual_on_slab</span><span class="p">();</span>
<span class="w">  </span><span class="kt">void</span>
<span class="w">  </span><span class="nf">assemble_system_on_slab</span><span class="p">();</span>
<span class="w">  </span><span class="kt">void</span>
<span class="w">  </span><span class="nf">solve_Newton_problem_on_slab</span><span class="p">();</span>
<span class="w">  </span><span class="kt">void</span>
<span class="w">  </span><span class="nf">calculate_functional_values_on_slab</span><span class="p">();</span>
<span class="w">  </span><span class="kt">double</span>
<span class="w">  </span><span class="nf">calculate_pressure_at_point</span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Point</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w">                       </span><span class="n">x</span><span class="p">,</span>
<span class="w">                              </span><span class="k">const</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">Vector</span><span class="w"> </span><span class="o">&amp;</span><span class="n">u</span><span class="p">);</span>
<span class="w">  </span><span class="kt">void</span>
<span class="w">  </span><span class="nf">calculate_drag_lift_tensor</span><span class="p">(</span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">Vector</span><span class="w"> </span><span class="o">&amp;</span><span class="n">u</span><span class="p">,</span>
<span class="w">                             </span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">drag_lift_value</span><span class="p">);</span>

<span class="w">  </span><span class="kt">void</span>
<span class="w">  </span><span class="nf">output_results_on_slab</span><span class="p">();</span>

<span class="w">  </span><span class="n">MPI_Comm</span><span class="w"> </span><span class="n">mpi_comm</span><span class="p">;</span><span class="w"> </span><span class="c1">// MPI communicator</span>
<span class="w">  </span><span class="kt">bool</span><span class="w">     </span><span class="n">write_vtu</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">ofstream</span><span class="w">      </span><span class="n">functional_log</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">ostringstream</span><span class="w"> </span><span class="n">logname</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">nu_f</span><span class="p">;</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">ConditionalOStream</span><span class="w"> </span><span class="n">pout</span><span class="p">;</span>

<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">spacetime</span><span class="o">::</span><span class="n">parallel</span><span class="o">::</span><span class="n">distributed</span><span class="o">::</span><span class="n">fixed</span><span class="o">::</span><span class="n">Triangulation</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span>
<span class="w">                                     </span><span class="n">triangulation</span><span class="p">;</span>
<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">spacetime</span><span class="o">::</span><span class="n">DoFHandler</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w">  </span><span class="n">dof_handler</span><span class="p">;</span>
<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">spacetime</span><span class="o">::</span><span class="n">TrilinosVector</span><span class="w"> </span><span class="n">solution</span><span class="p">;</span>

<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">spacetime</span><span class="o">::</span><span class="n">DG_FiniteElement</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fe</span><span class="p">;</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">SparsityPattern</span><span class="w">                            </span><span class="n">slab_sparsity_pattern</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">AffineConstraints</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">slab_zero_constraints</span><span class="p">;</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">SparseMatrix</span><span class="w">             </span><span class="n">slab_system_matrix</span><span class="p">;</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">Vector</span><span class="w">              </span><span class="n">slab_system_rhs</span><span class="p">;</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">Vector</span><span class="w">              </span><span class="n">slab_initial_value</span><span class="p">;</span>
<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w">                                       </span><span class="n">slab</span><span class="p">;</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">Vector</span><span class="w"> </span><span class="n">slab_newton_update</span><span class="p">;</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">Vector</span><span class="w"> </span><span class="n">slab_owned_tmp</span><span class="p">;</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">Vector</span><span class="w"> </span><span class="n">slab_relevant_tmp</span><span class="p">;</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">IndexSet</span><span class="w"> </span><span class="n">slab_locally_owned_dofs</span><span class="p">;</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">IndexSet</span><span class="w"> </span><span class="n">slab_locally_relevant_dofs</span><span class="p">;</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">IndexSet</span><span class="w"> </span><span class="n">space_locally_owned_dofs</span><span class="p">;</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">IndexSet</span><span class="w"> </span><span class="n">space_locally_relevant_dofs</span><span class="p">;</span>

<span class="w">  </span><span class="k">struct</span>
<span class="w">  </span><span class="p">{</span>
<span class="w">    </span><span class="n">idealii</span><span class="o">::</span><span class="n">slab</span><span class="o">::</span><span class="n">parallel</span><span class="o">::</span><span class="n">distributed</span><span class="o">::</span><span class="n">TriaIterator</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tria</span><span class="p">;</span>
<span class="w">    </span><span class="n">idealii</span><span class="o">::</span><span class="n">slab</span><span class="o">::</span><span class="n">DoFHandlerIterator</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w">                  </span><span class="n">dof</span><span class="p">;</span>
<span class="w">    </span><span class="n">idealii</span><span class="o">::</span><span class="n">slab</span><span class="o">::</span><span class="n">TrilinosVectorIterator</span><span class="w">                 </span><span class="n">solution</span><span class="p">;</span>
<span class="w">  </span><span class="p">}</span><span class="w"> </span><span class="n">slab_its</span><span class="p">;</span>
<span class="p">};</span>

<span class="n">Step4</span><span class="o">::</span><span class="n">Step4</span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">temporal_degree</span><span class="p">,</span><span class="w"> </span><span class="kt">bool</span><span class="w"> </span><span class="n">write_vtu</span><span class="p">)</span>
<span class="w">  </span><span class="o">:</span><span class="w"> </span><span class="n">mpi_comm</span><span class="p">(</span><span class="n">MPI_COMM_WORLD</span><span class="p">)</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">write_vtu</span><span class="p">(</span><span class="n">write_vtu</span><span class="p">)</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">nu_f</span><span class="p">(</span><span class="mf">1.0e-3</span><span class="p">)</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">pout</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="p">,</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Utilities</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">this_mpi_process</span><span class="p">(</span><span class="n">mpi_comm</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">triangulation</span><span class="p">()</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">dof_handler</span><span class="p">(</span><span class="o">&amp;</span><span class="n">triangulation</span><span class="p">)</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">fe</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">FESystem</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">dealii</span><span class="o">::</span><span class="n">FE_Q</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
<span class="w">                                             </span><span class="mi">2</span><span class="p">,</span>
<span class="w">                                             </span><span class="n">dealii</span><span class="o">::</span><span class="n">FE_Q</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
<span class="w">                                             </span><span class="mi">1</span><span class="p">),</span>
<span class="w">       </span><span class="n">temporal_degree</span><span class="p">,</span>
<span class="w">       </span><span class="n">idealii</span><span class="o">::</span><span class="n">spacetime</span><span class="o">::</span><span class="n">DG_FiniteElement</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;::</span><span class="n">support_type</span><span class="o">::</span><span class="n">Legendre</span><span class="p">)</span>
<span class="w">  </span><span class="p">,</span><span class="w"> </span><span class="n">slab</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">logname</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;functional_log_dG&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">temporal_degree</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">Step4</span><span class="o">::</span><span class="n">run</span><span class="p">()</span><span class="w"> </span><span class="c1">// same as before</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">make_grid</span><span class="p">();</span>
<span class="w">  </span><span class="n">time_marching</span><span class="p">();</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">Step4</span><span class="o">::</span><span class="n">make_grid</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">space_tria</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="c1">// construct an MPI parallel triangulation</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">parallel</span><span class="o">::</span><span class="n">distributed</span><span class="o">::</span><span class="n">Triangulation</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="n">mpi_comm</span><span class="p">);</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">GridIn</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">grid_in</span><span class="p">;</span>
<span class="w">  </span><span class="n">grid_in</span><span class="p">.</span><span class="n">attach_triangulation</span><span class="p">(</span><span class="o">*</span><span class="n">space_tria</span><span class="p">);</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">ifstream</span><span class="w"> </span><span class="n">input_file</span><span class="p">(</span><span class="s">&quot;nsbench4.inp&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">grid_in</span><span class="p">.</span><span class="n">read_ucd</span><span class="p">(</span><span class="n">input_file</span><span class="p">);</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Point</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w">                          </span><span class="n">p</span><span class="p">(</span><span class="mf">0.2</span><span class="p">,</span><span class="w"> </span><span class="mf">0.2</span><span class="p">);</span>
<span class="w">  </span><span class="k">static</span><span class="w"> </span><span class="k">const</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">SphericalManifold</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">boundary</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">GridTools</span><span class="o">::</span><span class="n">copy_boundary_to_manifold_id</span><span class="p">(</span><span class="o">*</span><span class="n">space_tria</span><span class="p">);</span>
<span class="w">  </span><span class="n">space_tria</span><span class="o">-&gt;</span><span class="n">set_manifold</span><span class="p">(</span><span class="mi">80</span><span class="p">,</span><span class="w"> </span><span class="n">boundary</span><span class="p">);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">256</span><span class="p">;</span>
<span class="w">  </span><span class="n">triangulation</span><span class="p">.</span><span class="n">generate</span><span class="p">(</span><span class="n">space_tria</span><span class="p">,</span><span class="w"> </span><span class="n">M</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="mf">8.</span><span class="p">);</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n_ref_space</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span>
<span class="w">  </span><span class="n">triangulation</span><span class="p">.</span><span class="n">refine_global</span><span class="p">(</span><span class="n">n_ref_space</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="n">dof_handler</span><span class="p">.</span><span class="n">generate</span><span class="p">();</span>
<span class="w">  </span><span class="n">logname</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;_M&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">M</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;_lvl&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">n_ref_space</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;.csv&quot;</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">Step4</span><span class="o">::</span><span class="n">time_marching</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">TimeIteratorCollection</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">tic</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">idealii</span><span class="o">::</span><span class="n">TimeIteratorCollection</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">();</span>

<span class="w">  </span><span class="n">solution</span><span class="p">.</span><span class="n">reinit</span><span class="p">(</span><span class="n">triangulation</span><span class="p">.</span><span class="n">M</span><span class="p">());</span>

<span class="w">  </span><span class="n">slab_its</span><span class="p">.</span><span class="n">tria</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">triangulation</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
<span class="w">  </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="w">      </span><span class="o">=</span><span class="w"> </span><span class="n">dof_handler</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
<span class="w">  </span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">solution</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
<span class="w">  </span><span class="n">slab</span><span class="w">              </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="n">tic</span><span class="p">.</span><span class="n">add_iterator</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slab_its</span><span class="p">.</span><span class="n">tria</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">triangulation</span><span class="p">);</span>
<span class="w">  </span><span class="n">tic</span><span class="p">.</span><span class="n">add_iterator</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">dof_handler</span><span class="p">);</span>
<span class="w">  </span><span class="n">tic</span><span class="p">.</span><span class="n">add_iterator</span><span class="p">(</span><span class="o">&amp;</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">solution</span><span class="p">);</span>

<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dealii</span><span class="o">::</span><span class="n">Utilities</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">this_mpi_process</span><span class="p">(</span><span class="n">mpi_comm</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">cout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Opening functional log file: &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">logname</span><span class="p">.</span><span class="n">str</span><span class="p">()</span>
<span class="w">                </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">      </span><span class="n">functional_log</span><span class="p">.</span><span class="n">open</span><span class="p">(</span><span class="n">logname</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
<span class="w">      </span><span class="n">functional_log</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;t, pfront, pback, pdiff, drag, lift&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">  </span><span class="n">pout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;*******Starting time-stepping*********&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(;</span><span class="w"> </span><span class="o">!</span><span class="n">tic</span><span class="p">.</span><span class="n">at_end</span><span class="p">();</span><span class="w"> </span><span class="n">tic</span><span class="p">.</span><span class="n">increment</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">pout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Starting time-step (&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">tria</span><span class="o">-&gt;</span><span class="n">startpoint</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;,&quot;</span>
<span class="w">           </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">tria</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;)&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

<span class="w">      </span><span class="n">setup_system_on_slab</span><span class="p">();</span>
<span class="w">      </span><span class="n">solve_Newton_problem_on_slab</span><span class="p">();</span>

<span class="w">      </span><span class="n">calculate_functional_values_on_slab</span><span class="p">();</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">write_vtu</span><span class="p">)</span>
<span class="w">        </span><span class="n">output_results_on_slab</span><span class="p">();</span>

<span class="w">      </span><span class="n">idealii</span><span class="o">::</span><span class="n">slab</span><span class="o">::</span><span class="n">VectorTools</span><span class="o">::</span><span class="n">extract_subvector_at_time_point</span><span class="p">(</span>
<span class="w">        </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="p">,</span>
<span class="w">        </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="p">,</span>
<span class="w">        </span><span class="n">slab_initial_value</span><span class="p">,</span>
<span class="w">        </span><span class="n">slab_its</span><span class="p">.</span><span class="n">tria</span><span class="o">-&gt;</span><span class="n">endpoint</span><span class="p">());</span>
<span class="w">      </span><span class="n">slab</span><span class="o">++</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">dealii</span><span class="o">::</span><span class="n">Utilities</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">this_mpi_process</span><span class="p">(</span><span class="n">mpi_comm</span><span class="p">)</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">functional_log</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">Step4</span><span class="o">::</span><span class="n">setup_system_on_slab</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">distribute_dofs</span><span class="p">(</span><span class="n">fe</span><span class="p">);</span>


<span class="w">  </span><span class="n">pout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Number of degrees of freedom: </span><span class="se">\n\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">n_dofs_space</span><span class="p">()</span>
<span class="w">       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; (space) * &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">n_dofs_time</span><span class="p">()</span>
<span class="w">       </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; (time) = &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">n_dofs_spacetime</span><span class="p">()</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

<span class="w">  </span><span class="n">space_locally_owned_dofs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">spatial</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">locally_owned_dofs</span><span class="p">();</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">DoFTools</span><span class="o">::</span><span class="n">extract_locally_relevant_dofs</span><span class="p">(</span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">spatial</span><span class="p">(),</span>
<span class="w">                                                  </span><span class="n">space_locally_relevant_dofs</span><span class="p">);</span>

<span class="w">  </span><span class="n">slab_locally_owned_dofs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">locally_owned_dofs</span><span class="p">();</span>
<span class="w">  </span><span class="n">slab_locally_relevant_dofs</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">idealii</span><span class="o">::</span><span class="n">slab</span><span class="o">::</span><span class="n">DoFTools</span><span class="o">::</span><span class="n">extract_locally_relevant_dofs</span><span class="p">(</span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="p">);</span>

<span class="w">  </span><span class="n">slab_owned_tmp</span><span class="p">.</span><span class="n">reinit</span><span class="p">(</span><span class="n">slab_locally_owned_dofs</span><span class="p">,</span><span class="w"> </span><span class="n">mpi_comm</span><span class="p">);</span>
<span class="w">  </span><span class="n">slab_relevant_tmp</span><span class="p">.</span><span class="n">reinit</span><span class="p">(</span><span class="n">slab_locally_owned_dofs</span><span class="p">,</span>
<span class="w">                           </span><span class="n">slab_locally_relevant_dofs</span><span class="p">,</span>
<span class="w">                           </span><span class="n">mpi_comm</span><span class="p">);</span>
<span class="w">  </span><span class="n">slab_newton_update</span><span class="p">.</span><span class="n">reinit</span><span class="p">(</span><span class="n">slab_locally_owned_dofs</span><span class="p">,</span><span class="w"> </span><span class="n">mpi_comm</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">slab</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">slab_initial_value</span><span class="p">.</span><span class="n">reinit</span><span class="p">(</span><span class="n">space_locally_owned_dofs</span><span class="p">,</span>
<span class="w">                                </span><span class="n">space_locally_relevant_dofs</span><span class="p">,</span>
<span class="w">                                </span><span class="n">mpi_comm</span><span class="p">);</span>
<span class="w">      </span><span class="n">slab_initial_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">  </span><span class="n">slab_zero_constraints</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">AffineConstraints</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&gt;</span><span class="p">();</span>
<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">slab_initial_constraints</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">AffineConstraints</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&gt;</span><span class="p">();</span>
<span class="w">  </span><span class="k">auto</span><span class="w">              </span><span class="n">zero</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Functions</span><span class="o">::</span><span class="n">ZeroFunction</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>
<span class="w">  </span><span class="k">auto</span><span class="w">              </span><span class="n">inflow</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">PoisseuilleInflow</span><span class="p">();</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="w"> </span><span class="n">component_mask</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">);</span>
<span class="w">  </span><span class="n">component_mask</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span>

<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">slab</span><span class="o">::</span><span class="n">VectorTools</span><span class="o">::</span><span class="n">interpolate_boundary_values</span><span class="p">(</span>
<span class="w">    </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">inflow</span><span class="p">,</span><span class="w"> </span><span class="n">slab_initial_constraints</span><span class="p">,</span><span class="w"> </span><span class="n">component_mask</span><span class="p">);</span>

<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">slab</span><span class="o">::</span><span class="n">VectorTools</span><span class="o">::</span><span class="n">interpolate_boundary_values</span><span class="p">(</span>
<span class="w">    </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="n">slab_initial_constraints</span><span class="p">,</span><span class="w"> </span><span class="n">component_mask</span><span class="p">);</span>

<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">slab</span><span class="o">::</span><span class="n">VectorTools</span><span class="o">::</span><span class="n">interpolate_boundary_values</span><span class="p">(</span>
<span class="w">    </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="p">,</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="n">slab_initial_constraints</span><span class="p">,</span><span class="w"> </span><span class="n">component_mask</span><span class="p">);</span>

<span class="w">  </span><span class="n">slab_initial_constraints</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">();</span>

<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">slab</span><span class="o">::</span><span class="n">VectorTools</span><span class="o">::</span><span class="n">interpolate_boundary_values</span><span class="p">(</span>
<span class="w">    </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="p">,</span><span class="w"> </span><span class="mi">0</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="n">slab_zero_constraints</span><span class="p">,</span><span class="w"> </span><span class="n">component_mask</span><span class="p">);</span>

<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">slab</span><span class="o">::</span><span class="n">VectorTools</span><span class="o">::</span><span class="n">interpolate_boundary_values</span><span class="p">(</span>
<span class="w">    </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="n">slab_zero_constraints</span><span class="p">,</span><span class="w"> </span><span class="n">component_mask</span><span class="p">);</span>

<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">slab</span><span class="o">::</span><span class="n">VectorTools</span><span class="o">::</span><span class="n">interpolate_boundary_values</span><span class="p">(</span>
<span class="w">    </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="p">,</span><span class="w"> </span><span class="mi">80</span><span class="p">,</span><span class="w"> </span><span class="n">zero</span><span class="p">,</span><span class="w"> </span><span class="n">slab_zero_constraints</span><span class="p">,</span><span class="w"> </span><span class="n">component_mask</span><span class="p">);</span>

<span class="w">  </span><span class="n">slab_zero_constraints</span><span class="o">-&gt;</span><span class="n">close</span><span class="p">();</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">IndexSet</span><span class="o">::</span><span class="n">ElementIterator</span><span class="w"> </span><span class="n">lri</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">space_locally_owned_dofs</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">IndexSet</span><span class="o">::</span><span class="n">ElementIterator</span><span class="w"> </span><span class="n">lre</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">space_locally_owned_dofs</span><span class="p">.</span><span class="n">end</span><span class="p">();</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(;</span><span class="w"> </span><span class="n">lri</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">lre</span><span class="p">;</span><span class="w"> </span><span class="n">lri</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">ii</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">n_dofs_time</span><span class="p">();</span><span class="w"> </span><span class="n">ii</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="n">slab_owned_tmp</span><span class="p">[</span><span class="o">*</span><span class="n">lri</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">n_dofs_space</span><span class="p">()</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">ii</span><span class="p">]</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">slab_initial_value</span><span class="p">[</span><span class="o">*</span><span class="n">lri</span><span class="p">];</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="n">slab_initial_constraints</span><span class="o">-&gt;</span><span class="n">distribute</span><span class="p">(</span><span class="n">slab_owned_tmp</span><span class="p">);</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Table</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">DoFTools</span><span class="o">::</span><span class="n">Coupling</span><span class="o">&gt;</span><span class="w"> </span><span class="n">coupling_space</span><span class="p">(</span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">coupling_space</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">DoFTools</span><span class="o">::</span><span class="n">always</span><span class="p">;</span>
<span class="w">      </span><span class="n">coupling_space</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">DoFTools</span><span class="o">::</span><span class="n">always</span><span class="p">;</span>
<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="n">coupling_space</span><span class="p">[</span><span class="n">i</span><span class="p">][</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">DoFTools</span><span class="o">::</span><span class="n">always</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">DynamicSparsityPattern</span><span class="w"> </span><span class="n">dsp</span><span class="p">(</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">n_dofs_spacetime</span><span class="p">());</span>
<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">slab</span><span class="o">::</span><span class="n">DoFTools</span><span class="o">::</span><span class="n">make_upwind_sparsity_pattern</span><span class="p">(</span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="p">,</span>
<span class="w">                                                        </span><span class="n">coupling_space</span><span class="p">,</span>
<span class="w">                                                        </span><span class="n">dsp</span><span class="p">,</span>
<span class="w">                                                        </span><span class="n">slab_zero_constraints</span><span class="p">);</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">SparsityTools</span><span class="o">::</span><span class="n">distribute_sparsity_pattern</span><span class="p">(</span>
<span class="w">    </span><span class="n">dsp</span><span class="p">,</span><span class="w"> </span><span class="n">slab_locally_owned_dofs</span><span class="p">,</span><span class="w"> </span><span class="n">mpi_comm</span><span class="p">,</span><span class="w"> </span><span class="n">slab_locally_relevant_dofs</span><span class="p">);</span>


<span class="w">  </span><span class="n">slab_system_matrix</span><span class="p">.</span><span class="n">reinit</span><span class="p">(</span><span class="n">slab_locally_owned_dofs</span><span class="p">,</span>
<span class="w">                            </span><span class="n">slab_locally_owned_dofs</span><span class="p">,</span>
<span class="w">                            </span><span class="n">dsp</span><span class="p">);</span>

<span class="w">  </span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="o">-&gt;</span><span class="n">reinit</span><span class="p">(</span><span class="n">slab_locally_owned_dofs</span><span class="p">,</span>
<span class="w">                            </span><span class="n">slab_locally_relevant_dofs</span><span class="p">,</span>
<span class="w">                            </span><span class="n">mpi_comm</span><span class="p">);</span>
<span class="w">  </span><span class="n">slab_system_rhs</span><span class="p">.</span><span class="n">reinit</span><span class="p">(</span><span class="n">slab_locally_owned_dofs</span><span class="p">,</span><span class="w"> </span><span class="n">mpi_comm</span><span class="p">);</span>
<span class="w">  </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slab_owned_tmp</span><span class="p">;</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">Step4</span><span class="o">::</span><span class="n">assemble_system_on_slab</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">slab_system_matrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">spacetime</span><span class="o">::</span><span class="n">QGauss</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">quad</span><span class="p">(</span><span class="n">fe</span><span class="p">.</span><span class="n">spatial</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">degree</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<span class="w">                                     </span><span class="n">fe</span><span class="p">.</span><span class="n">temporal</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">degree</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>

<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">spacetime</span><span class="o">::</span><span class="n">FEValues</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fe_values_spacetime</span><span class="p">(</span>
<span class="w">    </span><span class="n">fe</span><span class="p">,</span>
<span class="w">    </span><span class="n">quad</span><span class="p">,</span>
<span class="w">    </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_values</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_gradients</span><span class="w"> </span><span class="o">|</span>
<span class="w">      </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_quadrature_points</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_JxW_values</span><span class="p">);</span>

<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">spacetime</span><span class="o">::</span><span class="n">FEJumpValues</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fe_jump_values_spacetime</span><span class="p">(</span>
<span class="w">    </span><span class="n">fe</span><span class="p">,</span>
<span class="w">    </span><span class="n">quad</span><span class="p">,</span>
<span class="w">    </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_values</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_gradients</span><span class="w"> </span><span class="o">|</span>
<span class="w">      </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_quadrature_points</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_JxW_values</span><span class="p">);</span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fe</span><span class="p">.</span><span class="n">dofs_per_cell</span><span class="p">;</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">tria</span><span class="o">-&gt;</span><span class="n">temporal</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">n_global_active_cells</span><span class="p">();</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">FullMatrix</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cell_matrix</span><span class="p">(</span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">,</span>
<span class="w">                                         </span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">);</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">types</span><span class="o">::</span><span class="n">global_dof_index</span><span class="o">&gt;</span><span class="w"> </span><span class="n">local_spacetime_dof_index</span><span class="p">(</span>
<span class="w">    </span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">);</span>

<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n_quad_spacetime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">n_quadrature_points</span><span class="p">;</span>
<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n_quad_space</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">quad</span><span class="p">.</span><span class="n">spatial</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">FEValuesExtractors</span><span class="o">::</span><span class="n">Vector</span><span class="w"> </span><span class="nf">velocity</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">FEValuesExtractors</span><span class="o">::</span><span class="n">Scalar</span><span class="w"> </span><span class="nf">pressure</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>


<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">old_solution_values</span><span class="p">(</span>
<span class="w">    </span><span class="n">n_quad_spacetime</span><span class="p">,</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="n">old_solution_grads</span><span class="p">(</span>
<span class="w">    </span><span class="n">n_quad_spacetime</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cell_space</span><span class="w"> </span><span class="o">:</span>
<span class="w">       </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">spatial</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">active_cell_iterators</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cell_space</span><span class="o">-&gt;</span><span class="n">is_locally_owned</span><span class="p">())</span><span class="w"> </span><span class="c1">// only rank local contributions</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">reinit_space</span><span class="p">(</span><span class="n">cell_space</span><span class="p">);</span>
<span class="w">          </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">reinit_space</span><span class="p">(</span><span class="n">cell_space</span><span class="p">);</span>

<span class="w">          </span><span class="n">cell_matrix</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>

<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cell_time</span><span class="w"> </span><span class="o">:</span>
<span class="w">               </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">temporal</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">active_cell_iterators</span><span class="p">())</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">              </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cell_time</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">();</span>
<span class="w">              </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">reinit_time</span><span class="p">(</span><span class="n">cell_time</span><span class="p">);</span>
<span class="w">              </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">reinit_time</span><span class="p">(</span><span class="n">cell_time</span><span class="p">);</span>
<span class="w">              </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">get_local_dof_indices</span><span class="p">(</span>
<span class="w">                </span><span class="n">local_spacetime_dof_index</span><span class="p">);</span>

<span class="w">              </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">get_function_values</span><span class="p">(</span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="p">,</span>
<span class="w">                                                      </span><span class="n">old_solution_values</span><span class="p">);</span>

<span class="w">              </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">get_function_space_gradients</span><span class="p">(</span>
<span class="w">                </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="p">,</span><span class="w"> </span><span class="n">old_solution_grads</span><span class="p">);</span>

<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_quad_spacetime</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">q</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">v</span><span class="p">;</span>
<span class="w">                  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">grad_v</span><span class="p">;</span>
<span class="w">                  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="o">++</span><span class="p">)</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                      </span><span class="n">v</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_solution_values</span><span class="p">[</span><span class="n">q</span><span class="p">](</span><span class="n">c</span><span class="p">);</span>
<span class="w">                      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="o">++</span><span class="p">)</span>
<span class="w">                        </span><span class="p">{</span>
<span class="w">                          </span><span class="n">grad_v</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">d</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_solution_grads</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">d</span><span class="p">];</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span>
<span class="w">                        </span><span class="p">{</span>
<span class="w">                          </span><span class="n">cell_matrix</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">,</span>
<span class="w">                                      </span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">)</span><span class="w"> </span><span class="o">+=</span>
<span class="w">                            </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">vector_value</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                            </span><span class="p">(</span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">vector_space_grad</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span>
<span class="w">                                                                   </span><span class="n">j</span><span class="p">,</span>
<span class="w">                                                                   </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                               </span><span class="n">v</span><span class="w"> </span><span class="o">+</span>
<span class="w">                             </span><span class="n">grad_v</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">vector_value</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span>
<span class="w">                                                                       </span><span class="n">j</span><span class="p">,</span>
<span class="w">                                                                       </span><span class="n">q</span><span class="p">))</span><span class="w"> </span><span class="o">*</span>
<span class="w">                            </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

<span class="w">                          </span><span class="n">cell_matrix</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">,</span>
<span class="w">                                      </span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">)</span><span class="w"> </span><span class="o">+=</span>
<span class="w">                            </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">vector_value</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                            </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">vector_dt</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                            </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

<span class="w">                          </span><span class="n">cell_matrix</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">,</span>
<span class="w">                                      </span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">)</span><span class="w"> </span><span class="o">+=</span>
<span class="w">                            </span><span class="n">dealii</span><span class="o">::</span><span class="n">scalar_product</span><span class="p">(</span>
<span class="w">                              </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">vector_space_grad</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span>
<span class="w">                                                                    </span><span class="n">i</span><span class="p">,</span>
<span class="w">                                                                    </span><span class="n">q</span><span class="p">),</span>
<span class="w">                              </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">vector_space_grad</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span>
<span class="w">                                                                    </span><span class="n">j</span><span class="p">,</span>
<span class="w">                                                                    </span><span class="n">q</span><span class="p">))</span><span class="w"> </span><span class="o">*</span>
<span class="w">                            </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">nu_f</span><span class="p">;</span>

<span class="w">                          </span><span class="n">cell_matrix</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">,</span>
<span class="w">                                      </span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">)</span><span class="w"> </span><span class="o">-=</span>
<span class="w">                            </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">vector_divergence</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span>
<span class="w">                                                                  </span><span class="n">i</span><span class="p">,</span>
<span class="w">                                                                  </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                            </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">scalar_value</span><span class="p">(</span><span class="n">pressure</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                            </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

<span class="w">                          </span><span class="n">cell_matrix</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">,</span>
<span class="w">                                      </span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">)</span><span class="w"> </span><span class="o">+=</span>
<span class="w">                            </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">scalar_value</span><span class="p">(</span><span class="n">pressure</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                            </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">vector_divergence</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span>
<span class="w">                                                                  </span><span class="n">j</span><span class="p">,</span>
<span class="w">                                                                  </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                            </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

<span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="c1">// dofs j</span>

<span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="c1">// dofs i</span>

<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="c1">// quad</span>

<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_quad_space</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">q</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">j</span><span class="p">)</span>
<span class="w">                        </span><span class="p">{</span>
<span class="w">                          </span><span class="n">cell_matrix</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">,</span>
<span class="w">                                      </span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">)</span><span class="w"> </span><span class="o">+=</span>
<span class="w">                            </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">vector_value_plus</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span>
<span class="w">                                                                       </span><span class="n">i</span><span class="p">,</span>
<span class="w">                                                                       </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                            </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">vector_value_plus</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span>
<span class="w">                                                                       </span><span class="n">j</span><span class="p">,</span>
<span class="w">                                                                       </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                            </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

<span class="w">                          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                            </span><span class="p">{</span>
<span class="w">                              </span><span class="n">cell_matrix</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">,</span>
<span class="w">                                          </span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                                                </span><span class="n">dofs_per_spacetime_cell</span><span class="p">)</span><span class="w"> </span><span class="o">-=</span>
<span class="w">                                </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">vector_value_plus</span><span class="p">(</span>
<span class="w">                                  </span><span class="n">velocity</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                                </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">vector_value_minus</span><span class="p">(</span>
<span class="w">                                  </span><span class="n">velocity</span><span class="p">,</span><span class="w"> </span><span class="n">j</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                                </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
<span class="w">                            </span><span class="p">}</span>
<span class="w">                        </span><span class="p">}</span><span class="w"> </span><span class="c1">// dofs j</span>

<span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="c1">// dofs i</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="c1">// cell time</span>
<span class="w">          </span><span class="n">slab_zero_constraints</span><span class="o">-&gt;</span><span class="n">distribute_local_to_global</span><span class="p">(</span>
<span class="w">            </span><span class="n">cell_matrix</span><span class="p">,</span><span class="w"> </span><span class="n">local_spacetime_dof_index</span><span class="p">,</span><span class="w"> </span><span class="n">slab_system_matrix</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="c1">// cell space</span>

<span class="w">  </span><span class="n">slab_system_matrix</span><span class="p">.</span><span class="n">compress</span><span class="p">(</span><span class="n">dealii</span><span class="o">::</span><span class="n">VectorOperation</span><span class="o">::</span><span class="n">add</span><span class="p">);</span><span class="w"> </span><span class="c1">// communication</span>
<span class="p">}</span>


<span class="kt">void</span>
<span class="n">Step4</span><span class="o">::</span><span class="n">assemble_residual_on_slab</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">slab_system_rhs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">spacetime</span><span class="o">::</span><span class="n">QGauss</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">quad</span><span class="p">(</span><span class="n">fe</span><span class="p">.</span><span class="n">spatial</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">degree</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">3</span><span class="p">,</span>
<span class="w">                                     </span><span class="n">fe</span><span class="p">.</span><span class="n">temporal</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">degree</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">2</span><span class="p">);</span>

<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">spacetime</span><span class="o">::</span><span class="n">FEValues</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fe_values_spacetime</span><span class="p">(</span>
<span class="w">    </span><span class="n">fe</span><span class="p">,</span>
<span class="w">    </span><span class="n">quad</span><span class="p">,</span>
<span class="w">    </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_values</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_gradients</span><span class="w"> </span><span class="o">|</span>
<span class="w">      </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_quadrature_points</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_JxW_values</span><span class="p">);</span>

<span class="w">  </span><span class="n">idealii</span><span class="o">::</span><span class="n">spacetime</span><span class="o">::</span><span class="n">FEJumpValues</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fe_jump_values_spacetime</span><span class="p">(</span>
<span class="w">    </span><span class="n">fe</span><span class="p">,</span>
<span class="w">    </span><span class="n">quad</span><span class="p">,</span>
<span class="w">    </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_values</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_gradients</span><span class="w"> </span><span class="o">|</span>
<span class="w">      </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_quadrature_points</span><span class="w"> </span><span class="o">|</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_JxW_values</span><span class="p">);</span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fe</span><span class="p">.</span><span class="n">dofs_per_cell</span><span class="p">;</span>

<span class="w">  </span><span class="k">auto</span><span class="w">                   </span><span class="n">N</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">tria</span><span class="o">-&gt;</span><span class="n">temporal</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">n_global_active_cells</span><span class="p">();</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">cell_rhs</span><span class="p">(</span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">);</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">types</span><span class="o">::</span><span class="n">global_dof_index</span><span class="o">&gt;</span><span class="w"> </span><span class="n">local_spacetime_dof_index</span><span class="p">(</span>
<span class="w">    </span><span class="n">N</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">);</span>

<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n</span><span class="p">;</span>
<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n_quad_spacetime</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">n_quadrature_points</span><span class="p">;</span>
<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n_quad_space</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">quad</span><span class="p">.</span><span class="n">spatial</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">FEValuesExtractors</span><span class="o">::</span><span class="n">Vector</span><span class="w"> </span><span class="nf">velocity</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">FEValuesExtractors</span><span class="o">::</span><span class="n">Scalar</span><span class="w"> </span><span class="nf">pressure</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">old_solution_values</span><span class="p">(</span>
<span class="w">    </span><span class="n">n_quad_spacetime</span><span class="p">,</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">old_solution_dt</span><span class="p">(</span>
<span class="w">    </span><span class="n">n_quad_spacetime</span><span class="p">,</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="n">old_solution_grads</span><span class="p">(</span>
<span class="w">    </span><span class="n">n_quad_spacetime</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">old_solution_plus</span><span class="p">(</span>
<span class="w">    </span><span class="n">n_quad_space</span><span class="p">,</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">old_solution_minus</span><span class="p">(</span>
<span class="w">    </span><span class="n">n_quad_space</span><span class="p">,</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cell_space</span><span class="w"> </span><span class="o">:</span>
<span class="w">       </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">spatial</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">active_cell_iterators</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cell_space</span><span class="o">-&gt;</span><span class="n">is_locally_owned</span><span class="p">())</span><span class="w"> </span><span class="c1">// only rank local contributions</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">reinit_space</span><span class="p">(</span><span class="n">cell_space</span><span class="p">);</span>
<span class="w">          </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">reinit_space</span><span class="p">(</span><span class="n">cell_space</span><span class="p">);</span>

<span class="w">          </span><span class="n">cell_rhs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cell_time</span><span class="w"> </span><span class="o">:</span>
<span class="w">               </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">temporal</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">active_cell_iterators</span><span class="p">())</span>
<span class="w">            </span><span class="p">{</span>
<span class="w">              </span><span class="n">n</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">cell_time</span><span class="o">-&gt;</span><span class="n">index</span><span class="p">();</span>
<span class="w">              </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">reinit_time</span><span class="p">(</span><span class="n">cell_time</span><span class="p">);</span>
<span class="w">              </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">reinit_time</span><span class="p">(</span><span class="n">cell_time</span><span class="p">);</span>
<span class="w">              </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">get_local_dof_indices</span><span class="p">(</span>
<span class="w">                </span><span class="n">local_spacetime_dof_index</span><span class="p">);</span>

<span class="w">              </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">get_function_values</span><span class="p">(</span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="p">,</span>
<span class="w">                                                      </span><span class="n">old_solution_values</span><span class="p">);</span>

<span class="w">              </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">get_function_dt</span><span class="p">(</span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="p">,</span>
<span class="w">                                                  </span><span class="n">old_solution_dt</span><span class="p">);</span>

<span class="w">              </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">get_function_space_gradients</span><span class="p">(</span>
<span class="w">                </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="p">,</span><span class="w"> </span><span class="n">old_solution_grads</span><span class="p">);</span>

<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_quad_spacetime</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">q</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">v</span><span class="p">;</span>
<span class="w">                  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">dt_v</span><span class="p">;</span>
<span class="w">                  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">grad_v</span><span class="p">;</span>

<span class="w">                  </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_solution_values</span><span class="p">[</span><span class="n">q</span><span class="p">](</span><span class="mi">2</span><span class="p">);</span>
<span class="w">                  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="o">++</span><span class="p">)</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                      </span><span class="n">v</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="n">old_solution_values</span><span class="p">[</span><span class="n">q</span><span class="p">](</span><span class="n">c</span><span class="p">);</span>
<span class="w">                      </span><span class="n">dt_v</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_solution_dt</span><span class="p">[</span><span class="n">q</span><span class="p">](</span><span class="n">c</span><span class="p">);</span>
<span class="w">                      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">d</span><span class="o">++</span><span class="p">)</span>
<span class="w">                        </span><span class="p">{</span>
<span class="w">                          </span><span class="n">grad_v</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="n">d</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_solution_grads</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="n">c</span><span class="p">][</span><span class="n">d</span><span class="p">];</span>
<span class="w">                        </span><span class="p">}</span>
<span class="w">                    </span><span class="p">}</span>
<span class="w">                  </span><span class="k">const</span><span class="w"> </span><span class="kt">double</span><span class="w"> </span><span class="n">div_v</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">trace</span><span class="p">(</span><span class="n">grad_v</span><span class="p">);</span>

<span class="w">                  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                      </span><span class="n">cell_rhs</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">)</span><span class="w"> </span><span class="o">-=</span>
<span class="w">                        </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">vector_value</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                        </span><span class="n">dt_v</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

<span class="w">                      </span><span class="n">cell_rhs</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">)</span><span class="w"> </span><span class="o">-=</span>
<span class="w">                        </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">vector_value</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                        </span><span class="n">grad_v</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">v</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

<span class="w">                      </span><span class="n">cell_rhs</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">)</span><span class="w"> </span><span class="o">-=</span>
<span class="w">                        </span><span class="n">nu_f</span><span class="w"> </span><span class="o">*</span>
<span class="w">                        </span><span class="n">dealii</span><span class="o">::</span><span class="n">scalar_product</span><span class="p">(</span>
<span class="w">                          </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">vector_space_grad</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">),</span>
<span class="w">                          </span><span class="n">grad_v</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                        </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

<span class="w">                      </span><span class="n">cell_rhs</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">)</span><span class="w"> </span><span class="o">+=</span>
<span class="w">                        </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">vector_divergence</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                        </span><span class="n">p</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

<span class="w">                      </span><span class="n">cell_rhs</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">)</span><span class="w"> </span><span class="o">-=</span>
<span class="w">                        </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">scalar_value</span><span class="p">(</span><span class="n">pressure</span><span class="p">,</span><span class="w"> </span><span class="n">i</span><span class="p">,</span><span class="w"> </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                        </span><span class="n">div_v</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

<span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="c1">// dofs i</span>

<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="c1">// quad</span>

<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                  </span><span class="n">fe_values_spacetime</span><span class="p">.</span><span class="n">spatial</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_function_values</span><span class="p">(</span>
<span class="w">                    </span><span class="n">slab_initial_value</span><span class="p">,</span><span class="w"> </span><span class="n">old_solution_minus</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>

<span class="w">              </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">get_function_values_plus</span><span class="p">(</span>
<span class="w">                </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="p">,</span><span class="w"> </span><span class="n">old_solution_plus</span><span class="p">);</span>

<span class="w">              </span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">v_plus</span><span class="p">;</span>
<span class="w">              </span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">v_minus</span><span class="p">;</span>

<span class="w">              </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_quad_space</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">q</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">c</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">c</span><span class="p">)</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                      </span><span class="n">v_plus</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">old_solution_plus</span><span class="p">[</span><span class="n">q</span><span class="p">](</span><span class="n">c</span><span class="p">);</span>
<span class="w">                      </span><span class="n">v_minus</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">old_solution_minus</span><span class="p">[</span><span class="n">q</span><span class="p">](</span><span class="n">c</span><span class="p">);</span>
<span class="w">                    </span><span class="p">}</span>

<span class="w">                  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">i</span><span class="p">)</span>
<span class="w">                    </span><span class="p">{</span>
<span class="w">                      </span><span class="n">cell_rhs</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">)</span><span class="w"> </span><span class="o">-=</span>
<span class="w">                        </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">vector_value_plus</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span>
<span class="w">                                                                   </span><span class="n">i</span><span class="p">,</span>
<span class="w">                                                                   </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                        </span><span class="n">v_plus</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

<span class="w">                      </span><span class="n">cell_rhs</span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">n</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">dofs_per_spacetime_cell</span><span class="p">)</span><span class="w"> </span><span class="o">+=</span>
<span class="w">                        </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">vector_value_plus</span><span class="p">(</span><span class="n">velocity</span><span class="p">,</span>
<span class="w">                                                                   </span><span class="n">i</span><span class="p">,</span>
<span class="w">                                                                   </span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                        </span><span class="n">v_minus</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>

<span class="w">                    </span><span class="p">}</span><span class="w"> </span><span class="c1">// dofs i</span>

<span class="w">                </span><span class="p">}</span><span class="w"> </span><span class="c1">// quad_space</span>
<span class="w">              </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">n</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">N</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span>
<span class="w">                </span><span class="p">{</span>
<span class="w">                  </span><span class="n">fe_jump_values_spacetime</span><span class="p">.</span><span class="n">get_function_values_minus</span><span class="p">(</span>
<span class="w">                    </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="p">,</span><span class="w"> </span><span class="n">old_solution_minus</span><span class="p">);</span>
<span class="w">                </span><span class="p">}</span>
<span class="w">            </span><span class="p">}</span><span class="w"> </span><span class="c1">// cell time</span>
<span class="w">          </span><span class="n">slab_zero_constraints</span><span class="o">-&gt;</span><span class="n">distribute_local_to_global</span><span class="p">(</span>
<span class="w">            </span><span class="n">cell_rhs</span><span class="p">,</span><span class="w"> </span><span class="n">local_spacetime_dof_index</span><span class="p">,</span><span class="w"> </span><span class="n">slab_system_rhs</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="c1">// cell space</span>

<span class="w">  </span><span class="n">slab_system_rhs</span><span class="p">.</span><span class="n">compress</span><span class="p">(</span><span class="n">dealii</span><span class="o">::</span><span class="n">VectorOperation</span><span class="o">::</span><span class="n">add</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">Step4</span><span class="o">::</span><span class="n">solve_Newton_problem_on_slab</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">pout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;Starting Newton solve&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">SolverControl</span><span class="w"> </span><span class="nf">sc</span><span class="p">(</span><span class="mi">10000</span><span class="p">,</span><span class="w"> </span><span class="mf">1.0e-14</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">);</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">SolverDirect</span><span class="o">::</span><span class="n">AdditionalData</span><span class="w"> </span><span class="n">ad</span><span class="p">(</span><span class="nb">false</span><span class="p">,</span>
<span class="w">                                                            </span><span class="s">&quot;Amesos_Klu&quot;</span><span class="p">);</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">solver</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">SolverDirect</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span><span class="w"> </span><span class="n">ad</span><span class="p">);</span>

<span class="w">  </span><span class="kt">double</span><span class="w">       </span><span class="n">newton_lower_bound</span><span class="w">       </span><span class="o">=</span><span class="w"> </span><span class="mf">1.0e-10</span><span class="p">;</span>
<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">max_newton_steps</span><span class="w">         </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">max_line_search_steps</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mi">10</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w">       </span><span class="n">newton_rebuild_parameter</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.1</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w">       </span><span class="n">newton_damping</span><span class="w">           </span><span class="o">=</span><span class="w"> </span><span class="mf">0.6</span><span class="p">;</span>

<span class="w">  </span><span class="n">assemble_residual_on_slab</span><span class="p">();</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">newton_residual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slab_system_rhs</span><span class="p">.</span><span class="n">linfty_norm</span><span class="p">();</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">old_newton_residual</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">new_newton_residual</span><span class="p">;</span>

<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">newton_step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span>
<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">line_search_step</span><span class="p">;</span>

<span class="w">  </span><span class="n">pout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;0</span><span class="se">\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">newton_residual</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

<span class="w">  </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">newton_residual</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">newton_lower_bound</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">         </span><span class="n">newton_step</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="n">max_newton_steps</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">old_newton_residual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newton_residual</span><span class="p">;</span>
<span class="w">      </span><span class="n">assemble_residual_on_slab</span><span class="p">();</span>
<span class="w">      </span><span class="n">newton_residual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slab_system_rhs</span><span class="p">.</span><span class="n">linfty_norm</span><span class="p">();</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newton_residual</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">newton_lower_bound</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="n">pout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;res</span><span class="se">\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">newton_residual</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">          </span><span class="k">break</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newton_residual</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">old_newton_residual</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">newton_rebuild_parameter</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="n">solver</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="k">nullptr</span><span class="p">;</span>
<span class="w">          </span><span class="n">solver</span><span class="w"> </span><span class="o">=</span>
<span class="w">            </span><span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">SolverDirect</span><span class="o">&gt;</span><span class="p">(</span><span class="n">sc</span><span class="p">,</span><span class="w"> </span><span class="n">ad</span><span class="p">);</span>
<span class="w">          </span><span class="n">assemble_system_on_slab</span><span class="p">();</span>

<span class="w">          </span><span class="n">solver</span><span class="o">-&gt;</span><span class="n">initialize</span><span class="p">(</span><span class="n">slab_system_matrix</span><span class="p">);</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">      </span><span class="n">solver</span><span class="o">-&gt;</span><span class="n">solve</span><span class="p">(</span><span class="n">slab_newton_update</span><span class="p">,</span><span class="w"> </span><span class="n">slab_system_rhs</span><span class="p">);</span>
<span class="w">      </span><span class="n">slab_zero_constraints</span><span class="o">-&gt;</span><span class="n">distribute</span><span class="p">(</span><span class="n">slab_newton_update</span><span class="p">);</span>
<span class="w">      </span><span class="n">slab_owned_tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="p">;</span>

<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="n">line_search_step</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">line_search_step</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">max_line_search_steps</span><span class="p">;</span>
<span class="w">           </span><span class="n">line_search_step</span><span class="o">++</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="n">slab_owned_tmp</span><span class="w"> </span><span class="o">+=</span><span class="w"> </span><span class="n">slab_newton_update</span><span class="p">;</span>
<span class="w">          </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slab_owned_tmp</span><span class="p">;</span>
<span class="w">          </span><span class="n">assemble_residual_on_slab</span><span class="p">();</span>

<span class="w">          </span><span class="n">new_newton_residual</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slab_system_rhs</span><span class="p">.</span><span class="n">linfty_norm</span><span class="p">();</span>
<span class="w">          </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">new_newton_residual</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">newton_residual</span><span class="p">)</span>
<span class="w">            </span><span class="k">break</span><span class="p">;</span>
<span class="w">          </span><span class="k">else</span>
<span class="w">            </span><span class="n">slab_owned_tmp</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">slab_newton_update</span><span class="p">;</span>

<span class="w">          </span><span class="n">slab_newton_update</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="n">newton_damping</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>

<span class="w">      </span><span class="n">pout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">setprecision</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">newton_step</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">scientific</span>
<span class="w">           </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">newton_residual</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">scientific</span>
<span class="w">           </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">newton_residual</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">old_newton_residual</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">;</span>

<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">newton_residual</span><span class="w"> </span><span class="o">/</span><span class="w"> </span><span class="n">old_newton_residual</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">newton_rebuild_parameter</span><span class="p">)</span>
<span class="w">        </span><span class="n">pout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;r</span><span class="se">\t</span><span class="s">&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="k">else</span>
<span class="w">        </span><span class="n">pout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot; </span><span class="se">\t</span><span class="s">&quot;</span><span class="p">;</span>

<span class="w">      </span><span class="n">pout</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">line_search_step</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">scientific</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>

<span class="w">      </span><span class="n">newton_step</span><span class="o">++</span><span class="p">;</span><span class="w"> </span><span class="c1">// Update working index</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">Step4</span><span class="o">::</span><span class="n">calculate_functional_values_on_slab</span><span class="p">()</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Quadrature</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">quad_time</span><span class="p">(</span>
<span class="w">    </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">temporal</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_fe</span><span class="p">(</span><span class="mi">0</span><span class="p">).</span><span class="n">get_unit_support_points</span><span class="p">());</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">FEValues</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fev</span><span class="p">(</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">temporal</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">get_fe</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span>
<span class="w">                          </span><span class="n">quad_time</span><span class="p">,</span>
<span class="w">                          </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_quadrature_points</span><span class="p">);</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">types</span><span class="o">::</span><span class="n">global_dof_index</span><span class="o">&gt;</span><span class="w"> </span><span class="n">local_indices</span><span class="p">(</span>
<span class="w">    </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">dofs_per_cell_time</span><span class="p">());</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">n_dofs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">n_dofs_time</span><span class="p">();</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">Vector</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="p">;</span>

<span class="w">  </span><span class="kt">double</span><span class="w">       </span><span class="n">time</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span><span class="p">;</span>
<span class="w">  </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">time_dof</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w">       </span><span class="n">pfront</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w">       </span><span class="n">pback</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span><span class="p">;</span>
<span class="w">  </span><span class="kt">double</span><span class="w">       </span><span class="n">pdiff</span><span class="w">    </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span><span class="p">;</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">drag_lift_tensor</span><span class="p">;</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Point</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">front</span><span class="p">(</span><span class="mf">0.15</span><span class="p">,</span><span class="w"> </span><span class="mf">0.2</span><span class="p">);</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Point</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">back</span><span class="p">(</span><span class="mf">0.25</span><span class="p">,</span><span class="w"> </span><span class="mf">0.2</span><span class="p">);</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">Vector</span><span class="w"> </span><span class="n">local_solution</span><span class="p">;</span>
<span class="w">  </span><span class="n">local_solution</span><span class="p">.</span><span class="n">reinit</span><span class="p">(</span><span class="n">space_locally_owned_dofs</span><span class="p">,</span>
<span class="w">                        </span><span class="n">space_locally_relevant_dofs</span><span class="p">,</span>
<span class="w">                        </span><span class="n">mpi_comm</span><span class="p">);</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cell_time</span><span class="w"> </span><span class="o">:</span>
<span class="w">       </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">temporal</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">active_cell_iterators</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">fev</span><span class="p">.</span><span class="n">reinit</span><span class="p">(</span><span class="n">cell_time</span><span class="p">);</span>
<span class="w">      </span><span class="n">cell_time</span><span class="o">-&gt;</span><span class="n">get_dof_indices</span><span class="p">(</span><span class="n">local_indices</span><span class="p">);</span>

<span class="w">      </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">quad_time</span><span class="p">.</span><span class="n">size</span><span class="p">();</span><span class="w"> </span><span class="o">++</span><span class="n">q</span><span class="p">)</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="n">time</span><span class="w">     </span><span class="o">=</span><span class="w"> </span><span class="n">fev</span><span class="p">.</span><span class="n">quadrature_point</span><span class="p">(</span><span class="n">q</span><span class="p">)[</span><span class="mi">0</span><span class="p">];</span>
<span class="w">          </span><span class="n">time_dof</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">local_indices</span><span class="p">[</span><span class="n">q</span><span class="p">];</span>

<span class="w">          </span><span class="n">idealii</span><span class="o">::</span><span class="n">slab</span><span class="o">::</span><span class="n">VectorTools</span><span class="o">::</span><span class="n">extract_subvector_at_time_dof</span><span class="p">(</span>
<span class="w">            </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="p">,</span><span class="w"> </span><span class="n">local_solution</span><span class="p">,</span><span class="w"> </span><span class="n">time_dof</span><span class="p">);</span>

<span class="w">          </span><span class="n">pfront</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">calculate_pressure_at_point</span><span class="p">(</span><span class="n">front</span><span class="p">,</span><span class="w"> </span><span class="n">local_solution</span><span class="p">);</span>
<span class="w">          </span><span class="n">pback</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">calculate_pressure_at_point</span><span class="p">(</span><span class="n">back</span><span class="p">,</span><span class="w"> </span><span class="n">local_solution</span><span class="p">);</span>
<span class="w">          </span><span class="n">pdiff</span><span class="w">  </span><span class="o">=</span><span class="w"> </span><span class="n">pfront</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">pback</span><span class="p">;</span>

<span class="w">          </span><span class="n">calculate_drag_lift_tensor</span><span class="p">(</span><span class="n">local_solution</span><span class="p">,</span><span class="w"> </span><span class="n">drag_lift_tensor</span><span class="p">);</span>

<span class="w">          </span><span class="n">functional_log</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">time</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">pfront</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">pback</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span>
<span class="w">                         </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">pdiff</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">drag_lift_tensor</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;, &quot;</span>
<span class="w">                         </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">drag_lift_tensor</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">endl</span><span class="p">;</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">double</span>
<span class="n">Step4</span><span class="o">::</span><span class="n">calculate_pressure_at_point</span><span class="p">(</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Point</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w">                       </span><span class="n">x</span><span class="p">,</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">Vector</span><span class="w"> </span><span class="o">&amp;</span><span class="n">u</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="w"> </span><span class="n">x_h</span><span class="p">(</span><span class="mi">3</span><span class="p">);</span>

<span class="w">  </span><span class="k">try</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">dealii</span><span class="o">::</span><span class="n">VectorTools</span><span class="o">::</span><span class="n">point_value</span><span class="p">(</span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">spatial</span><span class="p">(),</span><span class="w"> </span><span class="n">u</span><span class="p">,</span><span class="w"> </span><span class="n">x</span><span class="p">,</span><span class="w"> </span><span class="n">x_h</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="k">catch</span><span class="w"> </span><span class="p">(</span><span class="k">typename</span><span class="w"> </span><span class="nc">dealii</span><span class="o">::</span><span class="n">VectorTools</span><span class="o">::</span><span class="n">ExcPointNotAvailableHere</span><span class="w"> </span><span class="n">e</span><span class="p">)</span>
<span class="w">    </span><span class="p">{}</span>

<span class="w">  </span><span class="k">auto</span><span class="w"> </span><span class="n">minmax</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Utilities</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">min_max_avg</span><span class="p">(</span><span class="n">x_h</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span><span class="w"> </span><span class="n">mpi_comm</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">abs</span><span class="p">(</span><span class="n">minmax</span><span class="p">.</span><span class="n">min</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="n">minmax</span><span class="p">.</span><span class="n">max</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">minmax</span><span class="p">.</span><span class="n">min</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="k">else</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="n">minmax</span><span class="p">.</span><span class="n">max</span><span class="p">;</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">void</span>
<span class="n">Step4</span><span class="o">::</span><span class="n">calculate_drag_lift_tensor</span><span class="p">(</span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">Vector</span><span class="w"> </span><span class="o">&amp;</span><span class="n">u</span><span class="p">,</span>
<span class="w">                                  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="o">&amp;</span><span class="n">drag_lift_value</span><span class="p">)</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">QGauss</span><span class="o">&lt;</span><span class="mi">1</span><span class="o">&gt;</span><span class="w"> </span><span class="n">face_quad</span><span class="p">(</span><span class="mi">6</span><span class="p">);</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">FEFaceValues</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">fe_face_values</span><span class="p">(</span><span class="o">*</span><span class="n">fe</span><span class="p">.</span><span class="n">spatial</span><span class="p">(),</span>
<span class="w">                                         </span><span class="n">face_quad</span><span class="p">,</span>
<span class="w">                                         </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_values</span><span class="w"> </span><span class="o">|</span>
<span class="w">                                           </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_gradients</span><span class="w"> </span><span class="o">|</span>
<span class="w">                                           </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_normal_vectors</span><span class="w"> </span><span class="o">|</span>
<span class="w">                                           </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_JxW_values</span><span class="w"> </span><span class="o">|</span>
<span class="w">                                           </span><span class="n">dealii</span><span class="o">::</span><span class="n">update_quadrature_points</span><span class="p">);</span>

<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">dofs_per_cell</span><span class="w">   </span><span class="o">=</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">dofs_per_cell_space</span><span class="p">();</span>
<span class="w">  </span><span class="k">const</span><span class="w"> </span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">n_face_q_points</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">face_quad</span><span class="p">.</span><span class="n">size</span><span class="p">();</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="o">&gt;</span><span class="w"> </span><span class="n">local_dof_indices</span><span class="p">(</span><span class="n">dofs_per_cell</span><span class="p">);</span>

<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;&gt;</span><span class="w"> </span><span class="n">face_solution_values</span><span class="p">(</span>
<span class="w">    </span><span class="n">n_face_q_points</span><span class="p">,</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Vector</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;&gt;&gt;</span><span class="w"> </span><span class="n">face_solution_grads</span><span class="p">(</span>
<span class="w">    </span><span class="n">n_face_q_points</span><span class="p">,</span><span class="w"> </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">1</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;&gt;</span><span class="p">(</span><span class="mi">3</span><span class="p">));</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">pI</span><span class="p">;</span>
<span class="w">  </span><span class="n">pI</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">grad_v</span><span class="p">;</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Tensor</span><span class="o">&lt;</span><span class="mi">2</span><span class="p">,</span><span class="w"> </span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">stress</span>

<span class="w">    </span><span class="n">drag_lift_value</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mf">0.</span><span class="p">;</span>

<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="k">const</span><span class="w"> </span><span class="k">auto</span><span class="w"> </span><span class="o">&amp;</span><span class="n">cell</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">spatial</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">active_cell_iterators</span><span class="p">())</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">is_locally_owned</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">at_boundary</span><span class="p">())</span>
<span class="w">        </span><span class="p">{</span>
<span class="w">          </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">face</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">               </span><span class="n">face</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">GeometryInfo</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;::</span><span class="n">faces_per_cell</span><span class="p">;</span>
<span class="w">               </span><span class="o">++</span><span class="n">face</span><span class="p">)</span>
<span class="w">            </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">face</span><span class="p">(</span><span class="n">face</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">at_boundary</span><span class="p">()</span><span class="w"> </span><span class="o">&amp;&amp;</span>
<span class="w">                </span><span class="n">cell</span><span class="o">-&gt;</span><span class="n">face</span><span class="p">(</span><span class="n">face</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">boundary_id</span><span class="p">()</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="mi">80</span><span class="p">)</span>
<span class="w">              </span><span class="p">{</span>
<span class="w">                </span><span class="n">fe_face_values</span><span class="p">.</span><span class="n">reinit</span><span class="p">(</span><span class="n">cell</span><span class="p">,</span><span class="w"> </span><span class="n">face</span><span class="p">);</span>
<span class="w">                </span><span class="n">fe_face_values</span><span class="p">.</span><span class="n">get_function_values</span><span class="p">(</span><span class="n">slab_initial_value</span><span class="p">,</span>
<span class="w">                                                   </span><span class="n">face_solution_values</span><span class="p">);</span>
<span class="w">                </span><span class="n">fe_face_values</span><span class="p">.</span><span class="n">get_function_gradients</span><span class="p">(</span><span class="n">slab_initial_value</span><span class="p">,</span>
<span class="w">                                                      </span><span class="n">face_solution_grads</span><span class="p">);</span>

<span class="w">                </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">q</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_face_q_points</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">q</span><span class="p">)</span>
<span class="w">                  </span><span class="p">{</span>
<span class="w">                    </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">l</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">l</span><span class="p">)</span>
<span class="w">                      </span><span class="p">{</span>
<span class="w">                        </span><span class="n">pI</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">l</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">face_solution_values</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="mi">2</span><span class="p">];</span>
<span class="w">                        </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">m</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="o">++</span><span class="n">m</span><span class="p">)</span>
<span class="w">                          </span><span class="p">{</span>
<span class="w">                            </span><span class="n">grad_v</span><span class="p">[</span><span class="n">l</span><span class="p">][</span><span class="n">m</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">face_solution_grads</span><span class="p">[</span><span class="n">q</span><span class="p">][</span><span class="n">l</span><span class="p">][</span><span class="n">m</span><span class="p">];</span>
<span class="w">                          </span><span class="p">}</span>
<span class="w">                      </span><span class="p">}</span>

<span class="w">                    </span><span class="n">stress</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">-</span><span class="n">pI</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">nu_f</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">grad_v</span><span class="p">;</span>

<span class="w">                    </span><span class="n">drag_lift_value</span><span class="w"> </span><span class="o">-=</span><span class="w"> </span><span class="n">stress</span><span class="w"> </span><span class="o">*</span>
<span class="w">                                       </span><span class="n">fe_face_values</span><span class="p">.</span><span class="n">normal_vector</span><span class="p">(</span><span class="n">q</span><span class="p">)</span><span class="w"> </span><span class="o">*</span>
<span class="w">                                       </span><span class="n">fe_face_values</span><span class="p">.</span><span class="n">JxW</span><span class="p">(</span><span class="n">q</span><span class="p">);</span>
<span class="w">                  </span><span class="p">}</span>
<span class="w">              </span><span class="p">}</span>
<span class="w">        </span><span class="p">}</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">  </span><span class="kt">double</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Utilities</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">sum</span><span class="p">(</span><span class="n">drag_lift_value</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="w"> </span><span class="n">mpi_comm</span><span class="p">);</span>
<span class="w">  </span><span class="n">drag_lift_value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span>
<span class="w">  </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">dealii</span><span class="o">::</span><span class="n">Utilities</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">sum</span><span class="p">(</span><span class="n">drag_lift_value</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="w"> </span><span class="n">mpi_comm</span><span class="p">);</span>
<span class="w">  </span><span class="n">drag_lift_value</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span>
<span class="w">  </span><span class="n">drag_lift_value</span><span class="w"> </span><span class="o">*=</span><span class="w"> </span><span class="mf">20.</span><span class="p">;</span>
<span class="p">}</span>
<span class="kt">void</span>
<span class="n">Step4</span><span class="o">::</span><span class="n">output_results_on_slab</span><span class="p">()</span><span class="w"> </span><span class="c1">// Nothing new compared to step-2</span>
<span class="p">{</span>
<span class="w">  </span><span class="k">auto</span><span class="w">                     </span><span class="n">n_dofs</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">n_dofs_time</span><span class="p">();</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">string</span><span class="o">&gt;</span><span class="w"> </span><span class="n">field_names</span><span class="p">;</span>
<span class="w">  </span><span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">dealii</span><span class="o">::</span><span class="n">DataComponentInterpretation</span><span class="o">::</span><span class="n">DataComponentInterpretation</span><span class="o">&gt;</span>
<span class="w">    </span><span class="n">dci</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">2</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">field_names</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="s">&quot;velocity&quot;</span><span class="p">);</span>
<span class="w">      </span><span class="n">dci</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span>
<span class="w">        </span><span class="n">dealii</span><span class="o">::</span><span class="n">DataComponentInterpretation</span><span class="o">::</span><span class="n">component_is_part_of_vector</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="n">field_names</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="s">&quot;pressure&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">dci</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">dealii</span><span class="o">::</span><span class="n">DataComponentInterpretation</span><span class="o">::</span><span class="n">component_is_scalar</span><span class="p">);</span>

<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">Vector</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">solution</span><span class="p">;</span>
<span class="w">  </span><span class="k">for</span><span class="w"> </span><span class="p">(</span><span class="kt">unsigned</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="n">n_dofs</span><span class="p">;</span><span class="w"> </span><span class="n">i</span><span class="o">++</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="n">dealii</span><span class="o">::</span><span class="n">DataOut</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;</span><span class="w"> </span><span class="n">data_out</span><span class="p">;</span>
<span class="w">      </span><span class="n">data_out</span><span class="p">.</span><span class="n">attach_dof_handler</span><span class="p">(</span><span class="o">*</span><span class="n">slab_its</span><span class="p">.</span><span class="n">dof</span><span class="o">-&gt;</span><span class="n">spatial</span><span class="p">());</span>
<span class="w">      </span><span class="n">dealii</span><span class="o">::</span><span class="n">TrilinosWrappers</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">Vector</span><span class="w"> </span><span class="n">local_solution</span><span class="p">;</span>
<span class="w">      </span><span class="n">local_solution</span><span class="p">.</span><span class="n">reinit</span><span class="p">(</span><span class="n">space_locally_owned_dofs</span><span class="p">,</span>
<span class="w">                            </span><span class="n">space_locally_relevant_dofs</span><span class="p">,</span>
<span class="w">                            </span><span class="n">mpi_comm</span><span class="p">);</span>

<span class="w">      </span><span class="n">idealii</span><span class="o">::</span><span class="n">slab</span><span class="o">::</span><span class="n">VectorTools</span><span class="o">::</span><span class="n">extract_subvector_at_time_dof</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span>
<span class="w">                                                                </span><span class="n">local_solution</span><span class="p">,</span>
<span class="w">                                                                </span><span class="n">i</span><span class="p">);</span>

<span class="w">      </span><span class="n">data_out</span><span class="p">.</span><span class="n">add_data_vector</span><span class="p">(</span><span class="n">local_solution</span><span class="p">,</span>
<span class="w">                               </span><span class="n">field_names</span><span class="p">,</span>
<span class="w">                               </span><span class="n">dealii</span><span class="o">::</span><span class="n">DataOut</span><span class="o">&lt;</span><span class="mi">2</span><span class="o">&gt;::</span><span class="n">type_dof_data</span><span class="p">,</span>
<span class="w">                               </span><span class="n">dci</span><span class="p">);</span>
<span class="w">      </span><span class="n">data_out</span><span class="p">.</span><span class="n">build_patches</span><span class="p">(</span><span class="mi">2</span><span class="p">);</span>
<span class="w">      </span><span class="n">std</span><span class="o">::</span><span class="n">ostringstream</span><span class="w"> </span><span class="n">filename</span><span class="p">;</span>
<span class="w">      </span><span class="n">filename</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;newton_navierstokes_solution_dG(&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">fe</span><span class="p">.</span><span class="n">temporal</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">degree</span>
<span class="w">               </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;)_t_&quot;</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="n">slab</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">n_dofs</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&lt;&lt;</span><span class="w"> </span><span class="s">&quot;.vtu&quot;</span><span class="p">;</span>
<span class="w">      </span><span class="n">data_out</span><span class="p">.</span><span class="n">write_vtu_in_parallel</span><span class="p">(</span><span class="n">filename</span><span class="p">.</span><span class="n">str</span><span class="p">().</span><span class="n">c_str</span><span class="p">(),</span><span class="w"> </span><span class="n">mpi_comm</span><span class="p">);</span>
<span class="w">    </span><span class="p">}</span>
<span class="p">}</span>

<span class="kt">int</span>
<span class="n">main</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="kt">char</span><span class="w"> </span><span class="o">*</span><span class="n">argv</span><span class="p">[])</span>
<span class="p">{</span>
<span class="w">  </span><span class="n">dealii</span><span class="o">::</span><span class="n">Utilities</span><span class="o">::</span><span class="n">MPI</span><span class="o">::</span><span class="n">MPI_InitFinalize</span><span class="w"> </span><span class="nf">mpi</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">,</span><span class="w"> </span><span class="mi">1</span><span class="p">);</span>

<span class="w">  </span><span class="n">Teuchos</span><span class="o">::</span><span class="n">CommandLineProcessor</span><span class="w"> </span><span class="n">clp</span><span class="p">;</span>
<span class="w">  </span><span class="n">clp</span><span class="p">.</span><span class="n">setDocString</span><span class="p">(</span>
<span class="w">    </span><span class="s">&quot;This example program demonstrates solving the Navier-Stokes &quot;</span>
<span class="w">    </span><span class="s">&quot;equation with Trilinos + MPI&quot;</span><span class="p">);</span>


<span class="w">  </span><span class="kt">bool</span><span class="w"> </span><span class="n">write_vtu</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<span class="w">  </span><span class="n">clp</span><span class="p">.</span><span class="n">setOption</span><span class="p">(</span><span class="s">&quot;write-vtu&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="s">&quot;no-vtu&quot;</span><span class="p">,</span>
<span class="w">                </span><span class="o">&amp;</span><span class="n">write_vtu</span><span class="p">,</span>
<span class="w">                </span><span class="s">&quot;Write results into vtu files?&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="kt">int</span><span class="w"> </span><span class="n">r</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<span class="w">  </span><span class="n">clp</span><span class="p">.</span><span class="n">setOption</span><span class="p">(</span><span class="s">&quot;r&quot;</span><span class="p">,</span><span class="w"> </span><span class="o">&amp;</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="s">&quot;temporal FE degree&quot;</span><span class="p">);</span>
<span class="w">  </span><span class="n">clp</span><span class="p">.</span><span class="n">throwExceptions</span><span class="p">(</span><span class="nb">false</span><span class="p">);</span>

<span class="w">  </span><span class="n">Teuchos</span><span class="o">::</span><span class="n">CommandLineProcessor</span><span class="o">::</span><span class="n">EParseCommandLineReturn</span><span class="w"> </span><span class="n">parse_return</span><span class="w"> </span><span class="o">=</span>
<span class="w">    </span><span class="n">clp</span><span class="p">.</span><span class="n">parse</span><span class="p">(</span><span class="n">argc</span><span class="p">,</span><span class="w"> </span><span class="n">argv</span><span class="p">);</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parse_return</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">Teuchos</span><span class="o">::</span><span class="n">CommandLineProcessor</span><span class="o">::</span><span class="n">PARSE_HELP_PRINTED</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span><span class="w"> </span><span class="c1">// don&#39;t fail if the program was called with ``--help``.</span>
<span class="w">    </span><span class="p">}</span>
<span class="w">  </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">parse_return</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">Teuchos</span><span class="o">::</span><span class="n">CommandLineProcessor</span><span class="o">::</span><span class="n">PARSE_SUCCESSFUL</span><span class="p">)</span>
<span class="w">    </span><span class="p">{</span>
<span class="w">      </span><span class="k">return</span><span class="w"> </span><span class="mi">1</span><span class="p">;</span><span class="w"> </span><span class="c1">// Error!</span>
<span class="w">    </span><span class="p">}</span>

<span class="w">  </span><span class="n">Step4</span><span class="w"> </span><span class="n">problem</span><span class="p">(</span><span class="n">r</span><span class="p">,</span><span class="w"> </span><span class="n">write_vtu</span><span class="p">);</span>
<span class="w">  </span><span class="n">problem</span><span class="p">.</span><span class="n">run</span><span class="p">();</span>
<span class="p">}</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="step-3.html" class="btn btn-neutral float-left" title="Example 3: Solving the heat equation in parallel" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, the ideal.II authors.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>